<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Duyen Tran">
<meta name="dcterms.date" content="2024-05-30">

<title>Website - Pentathlon: Next Product to Buy Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../visualization.html"> 
<span class="menu-text">Visualization</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link active" data-scroll-target="#data-preparation">Data Preparation</a>
  <ul class="collapse">
  <li><a href="#pentathon-next-product-to-buy" id="toc-pentathon-next-product-to-buy" class="nav-link" data-scroll-target="#pentathon-next-product-to-buy">Pentathon: Next Product To Buy</a></li>
  </ul></li>
  <li><a href="#logistic-regression-model" id="toc-logistic-regression-model" class="nav-link" data-scroll-target="#logistic-regression-model">Logistic Regression Model</a>
  <ul class="collapse">
  <li><a href="#build-a-logistic-regression-model" id="toc-build-a-logistic-regression-model" class="nav-link" data-scroll-target="#build-a-logistic-regression-model">Build a logistic regression model</a></li>
  <li><a href="#for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase" id="toc-for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase" class="nav-link" data-scroll-target="#for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase">1. For each customer determine the message (i.e., endurance, strength, water, team, backcountry, racquet, or no-message) predicted to lead to the highest probability of purchase</a></li>
  <li><a href="#expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition" id="toc-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition" class="nav-link" data-scroll-target="#expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition">7. Expected profit per e-mailed customer if every customer is assigned randomly to one of the messages or the no-message condition?</a></li>
  </ul></li>
  <li><a href="#neural-networks-model" id="toc-neural-networks-model" class="nav-link" data-scroll-target="#neural-networks-model">Neural Networks Model</a>
  <ul class="collapse">
  <li><a href="#create-predictions" id="toc-create-predictions" class="nav-link" data-scroll-target="#create-predictions">1. Create predictions</a></li>
  <li><a href="#respective-message-maximizes-expected-profit" id="toc-respective-message-maximizes-expected-profit" class="nav-link" data-scroll-target="#respective-message-maximizes-expected-profit">4. Respective message maximizes expected profit</a></li>
  <li><a href="#expected-profitcustomer" id="toc-expected-profitcustomer" class="nav-link" data-scroll-target="#expected-profitcustomer">5. Expected profit/customer</a></li>
  <li><a href="#expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-options" id="toc-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-options" class="nav-link" data-scroll-target="#expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-options">7. Expected profit per e-mailed customer if every customer is assigned randomly to one of the messages options</a></li>
  <li><a href="#expected-profit-for-5000000-customers" id="toc-expected-profit-for-5000000-customers" class="nav-link" data-scroll-target="#expected-profit-for-5000000-customers">8. Expected profit for 5,000,000 customers</a></li>
  </ul></li>
  <li><a href="#random-forest-model" id="toc-random-forest-model" class="nav-link" data-scroll-target="#random-forest-model">Random Forest Model</a>
  <ul class="collapse">
  <li><a href="#train-a-random-forest-model-to-predict-the-next-product-to-buy" id="toc-train-a-random-forest-model-to-predict-the-next-product-to-buy" class="nav-link" data-scroll-target="#train-a-random-forest-model-to-predict-the-next-product-to-buy">Train a Random Forest Model to predict the next product to buy</a></li>
  <li><a href="#percentage-of-customers-to-message-and-not-to-message" id="toc-percentage-of-customers-to-message-and-not-to-message" class="nav-link" data-scroll-target="#percentage-of-customers-to-message-and-not-to-message">2. Percentage of customers to message and not to message</a></li>
  <li><a href="#expected-profit-2" id="toc-expected-profit-2" class="nav-link" data-scroll-target="#expected-profit-2">3. Expected profit</a></li>
  <li><a href="#expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition-1" id="toc-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition-1" class="nav-link" data-scroll-target="#expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition-1">7. Expected profit per e-mailed customer if every customer is assigned randomly to one of the messages or the no-message condition</a></li>
  </ul></li>
  <li><a href="#xgboost-model" id="toc-xgboost-model" class="nav-link" data-scroll-target="#xgboost-model">XGBoost Model</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions">Questions</a>
  <ul class="collapse">
  <li><a href="#for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase." id="toc-for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase." class="nav-link" data-scroll-target="#for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase.">1. For each customer determine the message (i.e., endurance, strength, water, team, backcountry, racquet, or no-message) predicted to lead to the highest probability of purchase.</a></li>
  <li><a href="#for-each-message-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase" id="toc-for-each-message-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase" class="nav-link" data-scroll-target="#for-each-message-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase">2. For each message, The percentage of customers for whom that message or no-message maximizes their probability of purchase:</a></li>
  <li><a href="#for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-expected-profit-cogs-is-60." id="toc-for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-expected-profit-cogs-is-60." class="nav-link" data-scroll-target="#for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-expected-profit-cogs-is-60.">For each customer, determine the message (i.e., endurance, strength, water, team, backcountry, racquet, or no-message) predicted to lead to the highest expected profit (COGS is 60%).</a></li>
  <li><a href="#report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit.-1" id="toc-report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit.-1" class="nav-link" data-scroll-target="#report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit.-1">4. Report for each message, i.e., endurance, racket, etc., and no-message, the percentage of customers for whom that (no) message maximizes their expected profit.</a></li>
  <li><a href="#the-expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer" id="toc-the-expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer" class="nav-link" data-scroll-target="#the-expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer">5. The expected profit can we obtain, on average, per customer if we customize the message to each customer</a></li>
  <li><a href="#the-expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message" id="toc-the-expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message" class="nav-link" data-scroll-target="#the-expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message">6. The expected profit per e-mailed customer if every customer receives the same message</a></li>
  <li><a href="#the-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition" id="toc-the-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition" class="nav-link" data-scroll-target="#the-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition">7. The expected profit per e-mailed customer if every customer is assigned randomly to one of the messages or the no-message condition</a></li>
  <li><a href="#for-the-typical-promotional-e-mail-blast-to-5000000-customers-the-improvement-in-percent-and-in-total-euros-could-pentathlon-achieve-by-customizing-the-message-or-no-message-to-each-customer" id="toc-for-the-typical-promotional-e-mail-blast-to-5000000-customers-the-improvement-in-percent-and-in-total-euros-could-pentathlon-achieve-by-customizing-the-message-or-no-message-to-each-customer" class="nav-link" data-scroll-target="#for-the-typical-promotional-e-mail-blast-to-5000000-customers-the-improvement-in-percent-and-in-total-euros-could-pentathlon-achieve-by-customizing-the-message-or-no-message-to-each-customer">8. For the typical promotional e-mail blast to 5,000,000 customers, The improvement (in percent and in total Euros) could Pentathlon achieve by customizing the message (or no-message) to each customer:</a></li>
  </ul></li>
  <li><a href="#improvement-profit-for-4-models" id="toc-improvement-profit-for-4-models" class="nav-link" data-scroll-target="#improvement-profit-for-4-models">Improvement Profit for 4 models</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Pentathlon: Next Product to Buy Models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Duyen Tran </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 30, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>PROJECT SUMMARY</p>
<p>• Project Goal: Optimize profit by tailoring email campaigns for 7 departments to individual customers based on predictive modeling.</p>
<p>Modeling Approach:</p>
<p>• Logistic Regression: Utilized for its ability to predict the probability of customer engagement based on email content. • Linear Regression: Employed to predict average order size from each customer as a continuous outcome. • Random Forest: Chosen for its robustness and ability to capture non-linear patterns and feature interactions. • Neural Network: Applied to leverage its deep learning capabilities in identifying complex patterns within customer data. • XGBoost:Selectedforitse iciency,modelperformance,andabilitytohandleavarietyofdata types and distributions.</p>
<p>Model Training and Tuning:</p>
<p>• Conducted comprehensive training and hyperparameter tuning for each model to ensure op- timal performance. • Employed methods like cross-validation and grid search, particularly for computationally intensive models like Random Forest.</p>
<p>Profit Analysis: • Evaluated the predicted profit increase from each model to identify the most effective ap- proach. • Analyzed model-specific trade-offs, such as training time (e.g., Random Forest’s extensive training period).</p>
<p>Email Policy Evaluation: • Assessed the impact of each model on the email policy proposal to ensure alignment with profit optimization goals.</p>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<div id="223f6f25" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyrsm <span class="im">as</span> rsm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="aa0f325f" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">## loading the data - this dataset must NOT be changed</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb <span class="op">=</span> pd.read_parquet(<span class="st">"pentathlon_nptb.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="pentathon-next-product-to-buy" class="level3">
<h3 class="anchored" data-anchor-id="pentathon-next-product-to-buy">Pentathon: Next Product To Buy</h3>
<p>The available data is based on the last e-mail sent to each Pentathlon customer. Hence, an observation or row in the data is a “customer-promotional e-mail” pair. The data contains the following basic demographic information available to Pentathlon:</p>
<ul>
<li>“age”: Customer age(coded in 4 buckets:“&lt;30”, “30 to 44”, “45 to 59”, and “&gt;=60”)</li>
<li>“female”: Gender identity coded as Female “yes” or “no”</li>
<li>“income”: Income in Euros, rounded to the nearest EUR5,000</li>
<li>“education”: Percentage of college graduates in the customer’s neighborhood, coded from 0-100</li>
<li>“children”: Average number of children in the customer’s neighborhood</li>
</ul>
<p>The data also contains basic historical information about customer purchases, specifically, a department-specific frequency measure.</p>
<ul>
<li>“freq_endurance-freq_racquet”: Number of purchases in each department in the last year, excluding any purchase in response to the last email.</li>
</ul>
<p>The key outcome variables are:</p>
<ul>
<li>“buyer”: Did the customer click on the e-mail and complete a purchase within two days of receiving the e-mail (“yes” or “no”)?</li>
<li>“total_os”: Total order size (in Euros) conditional on the customer having purchased (buyer == “yes”). This measures spending across all departments, not just the department that sent the message</li>
</ul>
<blockquote class="blockquote">
<p>Note: In addition to the six message groups, a seventh group of customers received no promotional e-mails for the duration of the test (“control”).</p>
</blockquote>
<div id="41fe284c" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 600000 entries, 0 to 599999
Data columns (total 16 columns):
 #   Column            Non-Null Count   Dtype   
---  ------            --------------   -----   
 0   custid            600000 non-null  object  
 1   buyer             600000 non-null  category
 2   total_os          600000 non-null  int32   
 3   message           600000 non-null  category
 4   age               600000 non-null  category
 5   female            600000 non-null  category
 6   income            600000 non-null  int32   
 7   education         600000 non-null  int32   
 8   children          600000 non-null  float64 
 9   freq_endurance    600000 non-null  int32   
 10  freq_strength     600000 non-null  int32   
 11  freq_water        600000 non-null  int32   
 12  freq_team         600000 non-null  int32   
 13  freq_backcountry  600000 non-null  int32   
 14  freq_racquet      600000 non-null  int32   
 15  training          600000 non-null  float64 
dtypes: category(4), float64(2), int32(9), object(1)
memory usage: 36.6+ MB</code></pre>
</div>
</div>
<div id="4a9af8c7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'buyer_yes'</span>] <span class="op">=</span> rsm.ifelse(pentathlon_nptb[<span class="st">'buyer'</span>] <span class="op">==</span> <span class="st">'yes'</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'buyer_yes'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>buyer_yes
0    585600
1     14400
Name: count, dtype: int64</code></pre>
</div>
</div>
<section id="check-the-training-data-and-testing-data-make-sure-they-are-splitted-a-70-30-ratio" class="level4">
<h4 class="anchored" data-anchor-id="check-the-training-data-and-testing-data-make-sure-they-are-splitted-a-70-30-ratio">Check the training data and testing data, make sure they are splitted a 70-30 ratio</h4>
<div id="aa348243" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(pentathlon_nptb[<span class="st">"message"</span>], pentathlon_nptb[<span class="st">"training"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">training</th>
<th data-quarto-table-cell-role="th">0.0</th>
<th data-quarto-table-cell-role="th">1.0</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>26179</td>
<td>60425</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">control</td>
<td>26043</td>
<td>61217</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">endurance</td>
<td>24773</td>
<td>58083</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">racquet</td>
<td>26316</td>
<td>60772</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">strength</td>
<td>25251</td>
<td>59029</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">team</td>
<td>25942</td>
<td>60850</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">water</td>
<td>25496</td>
<td>59624</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="0015cfcc" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.training.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>training
1.0    0.7
0.0    0.3
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<div id="44773e50" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.hist(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), bins<span class="op">=</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>array([[&lt;Axes: title={'center': 'total_os'}&gt;,
        &lt;Axes: title={'center': 'income'}&gt;,
        &lt;Axes: title={'center': 'education'}&gt;],
       [&lt;Axes: title={'center': 'children'}&gt;,
        &lt;Axes: title={'center': 'freq_endurance'}&gt;,
        &lt;Axes: title={'center': 'freq_strength'}&gt;],
       [&lt;Axes: title={'center': 'freq_water'}&gt;,
        &lt;Axes: title={'center': 'freq_team'}&gt;,
        &lt;Axes: title={'center': 'freq_backcountry'}&gt;],
       [&lt;Axes: title={'center': 'freq_racquet'}&gt;,
        &lt;Axes: title={'center': 'training'}&gt;,
        &lt;Axes: title={'center': 'buyer_yes'}&gt;]], dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-8-output-2.png" width="829" height="801" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="logistic-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="logistic-regression-model">Logistic Regression Model</h2>
<section id="check-cross-tab-between-the-outcome-variable-and-the-key-predictor-variable" class="level4">
<h4 class="anchored" data-anchor-id="check-cross-tab-between-the-outcome-variable-and-the-key-predictor-variable">Check cross tab between the outcome variable and the key predictor variable</h4>
<div id="5486fe07" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"age"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>ct.plot(plots <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, age
Null hyp : There is no association between buyer and age
Alt. hyp : There is an association between buyer and age

Row percentages:

age     &lt; 30 30 to 44 45 to 59   &gt;= 60   Total
buyer                                         
yes    9.42%   40.74%   38.18%  11.65%  100.0%
no     17.7%   31.16%   32.42%  18.72%  100.0%
Total  17.5%   31.39%   32.56%  18.55%  100.0%

Chi-squared: 1038.94 df(3), p.value &lt; .001
0.0% of cells have expected values below 5
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-9-output-2.png" width="579" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5f7aa718" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"children"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, children
Null hyp : There is no association between buyer and children
Alt. hyp : There is an association between buyer and children

Row percentages:

children    0.2    0.3    0.4    0.5    0.6     0.7    0.8     0.9     1.0  \
buyer                                                                        
yes       1.58%  2.16%  3.52%  4.06%  5.13%   7.48%  7.55%  10.71%  10.63%   
no        2.98%   4.2%  6.18%  7.23%   7.9%  10.42%  9.56%  10.81%   9.11%   
Total     2.94%  4.15%  6.12%  7.15%  7.84%  10.35%  9.51%   10.8%   9.15%   

children    1.1  ...   4.5   4.6   4.7    4.8   4.9   5.0   5.1   5.2   5.8  \
buyer            ...                                                          
yes       9.74%  ...  0.0%  0.0%  0.0%  0.01%  0.0%  0.0%  0.0%  0.0%  0.0%   
no        7.18%  ...  0.0%  0.0%  0.0%   0.0%  0.0%  0.0%  0.0%  0.0%  0.0%   
Total     7.24%  ...  0.0%  0.0%  0.0%   0.0%  0.0%  0.0%  0.0%  0.0%  0.0%   

children   Total  
buyer             
yes       100.0%  
no        100.0%  
Total     100.0%  

[3 rows x 53 columns]

Chi-squared: 2028.29 df(51), p.value &lt; .001
700.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="bc6a320f" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"message"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>ct.plot(plots <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, message
Null hyp : There is no association between buyer and message
Alt. hyp : There is an association between buyer and message

Row percentages:

message backcountry control endurance racquet strength    team   water   Total
buyer                                                                         
yes          13.97%  13.27%    15.37%  13.77%   14.85%  14.58%  14.19%  100.0%
no            14.4%  14.61%    13.79%  14.49%   14.03%  14.49%   14.2%  100.0%
Total        14.39%  14.58%    13.83%  14.47%   14.05%  14.49%   14.2%  100.0%

Chi-squared: 39.15 df(6), p.value &lt; .001
0.0% of cells have expected values below 5
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-11-output-2.png" width="579" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3d7e33c7" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"freq_endurance"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, freq_endurance
Null hyp : There is no association between buyer and freq_endurance
Alt. hyp : There is an association between buyer and freq_endurance

Row percentages:

freq_endurance       0       1       2       3      4      5      6      7  \
buyer                                                                        
yes              24.2%  16.15%  14.66%  12.23%  9.58%  7.76%  5.24%  3.76%   
no              56.16%   22.7%  10.21%   5.33%  2.82%  1.42%  0.72%  0.34%   
Total            55.4%  22.54%  10.32%    5.5%  2.98%  1.58%  0.83%  0.42%   

freq_endurance      8      9     10     11     12     13     14     15   Total  
buyer                                                                           
yes             2.56%  1.72%  0.97%  0.57%  0.34%  0.14%  0.11%  0.02%  100.0%  
no              0.16%  0.08%  0.03%  0.01%  0.01%   0.0%   0.0%   0.0%  100.0%  
Total           0.22%  0.12%  0.05%  0.03%  0.01%  0.01%   0.0%   0.0%  100.0%  

Chi-squared: 21259.53 df(15), p.value &lt; .001
150.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="4fc80316" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"freq_strength"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, freq_strength
Null hyp : There is no association between buyer and freq_strength
Alt. hyp : There is an association between buyer and freq_strength

Row percentages:

freq_strength       0       1       2      3      4      5      6      7  \
buyer                                                                      
yes             21.4%   9.33%   9.92%  8.99%  8.33%  8.32%  6.73%  6.43%   
no             46.85%   18.9%  11.59%  7.77%  5.32%  3.54%  2.26%  1.51%   
Total          46.24%  18.67%  11.55%   7.8%   5.4%  3.65%  2.37%  1.63%   

freq_strength      8      9  ...     15     16     17     18     19    20  \
buyer                        ...                                            
yes             5.1%  4.09%  ...  0.65%  0.51%  0.23%  0.25%  0.11%  0.1%   
no             0.94%  0.55%  ...  0.02%  0.01%  0.01%   0.0%   0.0%  0.0%   
Total          1.04%  0.64%  ...  0.03%  0.02%  0.01%  0.01%   0.0%  0.0%   

freq_strength     21     22     23   Total  
buyer                                       
yes            0.04%  0.05%  0.01%  100.0%  
no              0.0%   0.0%   0.0%  100.0%  
Total           0.0%   0.0%   0.0%  100.0%  

[3 rows x 25 columns]

Chi-squared: 22032.18 df(23), p.value &lt; .001
300.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="5f68d1c5" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"freq_water"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, freq_water
Null hyp : There is no association between buyer and freq_water
Alt. hyp : There is an association between buyer and freq_water

Row percentages:

freq_water       0       1      2      3      4      5      6      7      8  \
buyer                                                                         
yes         64.79%  18.38%   9.3%   4.7%  1.88%  0.66%  0.21%  0.06%  0.01%   
no          92.53%   5.72%  1.33%  0.32%  0.08%  0.01%   0.0%   0.0%   0.0%   
Total       91.87%   6.03%  1.52%  0.42%  0.12%  0.03%  0.01%   0.0%   0.0%   

freq_water   Total  
buyer               
yes         100.0%  
no          100.0%  
Total       100.0%  

Chi-squared: 16794.94 df(8), p.value &lt; .001
125.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="0aa4cc5f" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"freq_team"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, freq_team
Null hyp : There is no association between buyer and freq_team
Alt. hyp : There is an association between buyer and freq_team

Row percentages:

freq_team       0       1       2      3      4      5      6      7      8  \
buyer                                                                         
yes         39.2%  10.78%   9.88%  9.12%  8.45%   6.8%  4.74%  4.07%  2.71%   
no         59.12%  16.61%  10.14%  6.28%  3.73%  2.08%  1.08%  0.53%  0.24%   
Total      58.64%  16.47%  10.14%  6.35%  3.84%  2.19%  1.17%  0.61%   0.3%   

freq_team      9     10     11     12     13     14     15     16   Total  
buyer                                                                      
yes        1.87%  1.07%  0.62%  0.32%  0.12%   0.2%  0.05%  0.02%  100.0%  
no         0.11%  0.05%  0.02%  0.01%   0.0%   0.0%   0.0%   0.0%  100.0%  
Total      0.16%  0.07%  0.04%  0.02%  0.01%  0.01%   0.0%   0.0%  100.0%  

Chi-squared: 13743.4 df(16), p.value &lt; .001
175.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="5633b4f2" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"freq_backcountry"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, freq_backcountry
Null hyp : There is no association between buyer and freq_backcountry
Alt. hyp : There is an association between buyer and freq_backcountry

Row percentages:

freq_backcountry       0       1       2       3      4      5      6   Total
buyer                                                                        
yes               45.69%  20.77%  18.53%  10.39%  3.85%  0.73%  0.03%  100.0%
no                61.34%  28.61%   8.24%   1.57%  0.22%  0.02%   0.0%  100.0%
Total             60.97%  28.42%   8.49%   1.78%   0.3%  0.03%   0.0%  100.0%

Chi-squared: 11914.73 df(6), p.value &lt; .001
50.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="72b5f7e5" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"freq_racquet"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, freq_racquet
Null hyp : There is no association between buyer and freq_racquet
Alt. hyp : There is an association between buyer and freq_racquet

Row percentages:

freq_racquet       0       1       2       3       4      5      6      7  \
buyer                                                                       
yes           23.83%  18.48%   17.7%  13.82%  10.43%  7.43%  4.32%  2.42%   
no            48.75%  28.86%  12.68%   5.76%   2.48%  0.97%  0.34%  0.12%   
Total         48.15%  28.61%   12.8%   5.95%   2.68%  1.13%  0.44%  0.17%   

freq_racquet      8      9     10     11   Total  
buyer                                             
yes           0.97%  0.46%  0.13%  0.02%  100.0%  
no            0.03%  0.01%   0.0%   0.0%  100.0%  
Total         0.05%  0.02%   0.0%   0.0%  100.0%  

Chi-squared: 18774.72 df(11), p.value &lt; .001
100.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="a1b9ef18" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> rsm.basics.cross_tabs(pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"buyer"</span>, <span class="st">"income"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>ct.summary(output <span class="op">=</span> <span class="st">"perc_row"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-tabs
Data     : Not provided
Variables: buyer, income
Null hyp : There is no association between buyer and income
Alt. hyp : There is an association between buyer and income

Row percentages:

income     0   5000  10000  15000  20000  25000  30000   35000   40000  \
buyer                                                                    
yes     0.0%  0.01%   0.0%  0.16%  0.26%  0.52%  0.84%    1.3%   2.22%   
no      0.0%  0.03%  0.19%  0.73%  2.13%  4.78%  8.77%  11.78%   14.0%   
Total   0.0%  0.03%  0.18%  0.71%  2.09%  4.68%  8.58%  11.53%  13.72%   

income   45000  ... 160000 165000 170000 175000 180000 185000 190000 195000  \
buyer           ...                                                           
yes      3.83%  ...  0.26%  0.37%  0.19%  0.14%  0.19%  0.14%   0.1%  0.11%   
no      12.71%  ...   0.0%   0.0%   0.0%   0.0%   0.0%   0.0%   0.0%   0.0%   
Total    12.5%  ...  0.01%  0.01%  0.01%  0.01%  0.01%   0.0%   0.0%   0.0%   

income 200000   Total  
buyer                  
yes     0.54%  100.0%  
no      0.01%  100.0%  
Total   0.02%  100.0%  

[3 rows x 42 columns]

Chi-squared: 40347.2 df(40), p.value &lt; .001
400.0% of cells have expected values below 5
</code></pre>
</div>
</div>
<div id="f3a5d9e4" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">freq_strength</th>
<th data-quarto-table-cell-role="th">freq_water</th>
<th data-quarto-table-cell-role="th">freq_team</th>
<th data-quarto-table-cell-role="th">freq_backcountry</th>
<th data-quarto-table-cell-role="th">freq_racquet</th>
<th data-quarto-table-cell-role="th">training</th>
<th data-quarto-table-cell-role="th">buyer_yes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>4</td>
<td>0</td>
<td>1</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>2</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>U28</td>
<td>no</td>
<td>0</td>
<td>strength</td>
<td>&lt; 30</td>
<td>yes</td>
<td>25000</td>
<td>18</td>
<td>0.3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>U59</td>
<td>no</td>
<td>0</td>
<td>strength</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>36</td>
<td>1.2</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>2</td>
<td>0</td>
<td>3</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599989</td>
<td>U3462835</td>
<td>no</td>
<td>0</td>
<td>control</td>
<td>30 to 44</td>
<td>yes</td>
<td>45000</td>
<td>20</td>
<td>0.8</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599992</td>
<td>U3462858</td>
<td>no</td>
<td>0</td>
<td>control</td>
<td>45 to 59</td>
<td>yes</td>
<td>40000</td>
<td>16</td>
<td>1.1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599993</td>
<td>U3462877</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>&lt; 30</td>
<td>no</td>
<td>65000</td>
<td>30</td>
<td>1.0</td>
<td>2</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1.0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>5</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>2</td>
<td>1.0</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>420000 rows × 17 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="build-a-logistic-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="build-a-logistic-regression-model">Build a logistic regression model</h3>
<div id="a2d6b781" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> pentathlon_nptb.columns.to_list()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> evar[evar.index(<span class="st">"message"</span>):]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> evar[:evar.index(<span class="st">"freq_racquet"</span>)<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>evar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>['message',
 'age',
 'female',
 'income',
 'education',
 'children',
 'freq_endurance',
 'freq_strength',
 'freq_water',
 'freq_team',
 'freq_backcountry',
 'freq_racquet']</code></pre>
</div>
</div>
<div id="0f932288" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> rsm.model.logistic(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    rvar <span class="op">=</span> <span class="st">"buyer_yes"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    evar <span class="op">=</span> evar,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>lr.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Logistic regression (GLM)
Data                 : pentathlon_nptb
Response variable    : buyer_yes
Level                : None
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Null hyp.: There is no effect of x on buyer_yes
Alt. hyp.: There is an effect of x on buyer_yes

                       OR      OR%  coefficient  std.error  z.value p.value     
Intercept           0.000  -100.0%        -8.28      0.064 -128.837  &lt; .001  ***
message[control]    0.906    -9.4%        -0.10      0.042   -2.335    0.02    *
message[endurance]  1.250    25.0%         0.22      0.041    5.462  &lt; .001  ***
message[racquet]    0.993    -0.7%        -0.01      0.042   -0.171   0.864     
message[strength]   1.162    16.2%         0.15      0.041    3.660  &lt; .001  ***
message[team]       1.035     3.5%         0.03      0.041    0.823    0.41     
message[water]      1.056     5.6%         0.05      0.042    1.311    0.19     
age[30 to 44]       2.386   138.6%         0.87      0.039   22.353  &lt; .001  ***
age[45 to 59]       2.186   118.6%         0.78      0.040   19.555  &lt; .001  ***
age[&gt;= 60]          1.201    20.1%         0.18      0.048    3.805  &lt; .001  ***
female[no]          1.353    35.3%         0.30      0.024   12.574  &lt; .001  ***
income              1.000     0.0%         0.00      0.000   22.105  &lt; .001  ***
education           1.037     3.7%         0.04      0.001   32.809  &lt; .001  ***
children            1.618    61.8%         0.48      0.030   16.210  &lt; .001  ***
freq_endurance      1.101    10.1%         0.10      0.005   18.300  &lt; .001  ***
freq_strength       1.115    11.5%         0.11      0.003   33.044  &lt; .001  ***
freq_water          1.178    17.8%         0.16      0.014   12.026  &lt; .001  ***
freq_team           1.050     5.0%         0.05      0.004   10.797  &lt; .001  ***
freq_backcountry    1.188    18.8%         0.17      0.010   17.313  &lt; .001  ***
freq_racquet        1.110    11.0%         0.10      0.007   15.866  &lt; .001  ***

Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Pseudo R-squared (McFadden): 0.261
Pseudo R-squared (McFadden adjusted): 0.26
Area under the RO Curve (AUC): 0.884
Log-likelihood: -35159.009, AIC: 70358.018, BIC: 70576.978
Chi-squared: 24788.884, df(19), p.value &lt; 0.001 
Nr obs: 420,000</code></pre>
</div>
</div>
<div id="ca81b5e7" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>lr.coef.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">OR</th>
<th data-quarto-table-cell-role="th">OR%</th>
<th data-quarto-table-cell-role="th">coefficient</th>
<th data-quarto-table-cell-role="th">std.error</th>
<th data-quarto-table-cell-role="th">z.value</th>
<th data-quarto-table-cell-role="th">p.value</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Intercept</td>
<td>0.000</td>
<td>-99.975</td>
<td>-8.283</td>
<td>0.064</td>
<td>-128.837</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>message[T.control]</td>
<td>0.906</td>
<td>-9.372</td>
<td>-0.098</td>
<td>0.042</td>
<td>-2.335</td>
<td>0.020</td>
<td>*</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>message[T.endurance]</td>
<td>1.250</td>
<td>24.991</td>
<td>0.223</td>
<td>0.041</td>
<td>5.462</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>message[T.racquet]</td>
<td>0.993</td>
<td>-0.711</td>
<td>-0.007</td>
<td>0.042</td>
<td>-0.171</td>
<td>0.864</td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>message[T.strength]</td>
<td>1.162</td>
<td>16.227</td>
<td>0.150</td>
<td>0.041</td>
<td>3.660</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>message[T.team]</td>
<td>1.035</td>
<td>3.458</td>
<td>0.034</td>
<td>0.041</td>
<td>0.823</td>
<td>0.410</td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>message[T.water]</td>
<td>1.056</td>
<td>5.606</td>
<td>0.055</td>
<td>0.042</td>
<td>1.311</td>
<td>0.190</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>age[T.30 to 44]</td>
<td>2.386</td>
<td>138.587</td>
<td>0.870</td>
<td>0.039</td>
<td>22.353</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>age[T.45 to 59]</td>
<td>2.186</td>
<td>118.557</td>
<td>0.782</td>
<td>0.040</td>
<td>19.555</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>age[T.&gt;= 60]</td>
<td>1.201</td>
<td>20.099</td>
<td>0.183</td>
<td>0.048</td>
<td>3.805</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>female[T.no]</td>
<td>1.353</td>
<td>35.328</td>
<td>0.303</td>
<td>0.024</td>
<td>12.574</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>income</td>
<td>1.000</td>
<td>0.002</td>
<td>0.000</td>
<td>0.000</td>
<td>22.105</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>education</td>
<td>1.037</td>
<td>3.736</td>
<td>0.037</td>
<td>0.001</td>
<td>32.809</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>children</td>
<td>1.618</td>
<td>61.764</td>
<td>0.481</td>
<td>0.030</td>
<td>16.210</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>freq_endurance</td>
<td>1.101</td>
<td>10.083</td>
<td>0.096</td>
<td>0.005</td>
<td>18.300</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>freq_strength</td>
<td>1.115</td>
<td>11.550</td>
<td>0.109</td>
<td>0.003</td>
<td>33.044</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>freq_water</td>
<td>1.178</td>
<td>17.847</td>
<td>0.164</td>
<td>0.014</td>
<td>12.026</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>freq_team</td>
<td>1.050</td>
<td>4.978</td>
<td>0.049</td>
<td>0.004</td>
<td>10.797</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>freq_backcountry</td>
<td>1.188</td>
<td>18.795</td>
<td>0.172</td>
<td>0.010</td>
<td>17.313</td>
<td>0.000</td>
<td>***</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>freq_racquet</td>
<td>1.110</td>
<td>11.008</td>
<td>0.104</td>
<td>0.007</td>
<td>15.866</td>
<td>0.000</td>
<td>***</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="55a2a4fa" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>lr.summary(main <span class="op">=</span> <span class="va">False</span>, vif <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Pseudo R-squared (McFadden): 0.261
Pseudo R-squared (McFadden adjusted): 0.26
Area under the RO Curve (AUC): 0.884
Log-likelihood: -35159.009, AIC: 70358.018, BIC: 70576.978
Chi-squared: 24788.884, df(19), p.value &lt; 0.001 
Nr obs: 420,000

Variance inflation factors:

                    vif    Rsq
education         3.219  0.689
income            2.814  0.645
freq_endurance    1.686  0.407
freq_racquet      1.603  0.376
freq_strength     1.470  0.320
children          1.423  0.297
freq_team         1.339  0.253
age               1.307  0.235
freq_water        1.268  0.212
freq_backcountry  1.145  0.126
female            1.112  0.101
message           1.001  0.001</code></pre>
</div>
</div>
<div id="c3a464ff" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>lr.plot(<span class="st">"vimp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-24-output-1.png" width="591" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ef5ed9e3" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pred_lr'</span>] <span class="op">=</span> lr.predict(pentathlon_nptb)[<span class="st">'prediction'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7bbdcb51" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dct <span class="op">=</span> {<span class="st">"train"</span> : pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"test"</span> : pentathlon_nptb.query(<span class="st">"training == 0"</span>)}</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> rsm.gains_plot(dct, <span class="st">"buyer"</span>, <span class="st">"yes"</span>, <span class="st">"pred_lr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-26-output-1.png" width="606" height="429" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a55c1140" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on training set</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">'pred_lr'</span>]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">'buyer_yes'</span>]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual, pred)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>0.884</code></pre>
</div>
</div>
<div id="07f65580" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on test set</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">'pred_lr'</span>]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">'buyer_yes'</span>]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual, pred)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>0.883</code></pre>
</div>
</div>
<p>We can conclude that:</p>
<p>The AUC for the training set is 0.884, which indicates that the model has a very good ability to distinguish between the two classes in the training data.</p>
<p>The AUC for the test set is 0.883, which is slightly lower but still indicates a very good predictive performance on unseen data.</p>
<p>The fact that the test AUC is close to the training AUC suggests that the model is generalizing well and not overfitting significantly to the training data. A small decrease from training to test set performance is normal because models will usually perform slightly better on the data they were trained on.</p>
</section>
<section id="for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase" class="level3">
<h3 class="anchored" data-anchor-id="for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase">1. For each customer determine the message (i.e., endurance, strength, water, team, backcountry, racquet, or no-message) predicted to lead to the highest probability of purchase</h3>
<div id="1c0713cc" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the department of the message variable</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>message
control        87260
racquet        87088
team           86792
backcountry    86604
water          85120
strength       84280
endurance      82856
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="d9b87e8d" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_control_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_racquet_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_team_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_backcountry_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_water_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_strength_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_endurance_lr"</span>] <span class="op">=</span> lr.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">training</th>
<th data-quarto-table-cell-role="th">buyer_yes</th>
<th data-quarto-table-cell-role="th">pred_lr</th>
<th data-quarto-table-cell-role="th">p_control_lr</th>
<th data-quarto-table-cell-role="th">p_racquet_lr</th>
<th data-quarto-table-cell-role="th">p_team_lr</th>
<th data-quarto-table-cell-role="th">p_backcountry_lr</th>
<th data-quarto-table-cell-role="th">p_water_lr</th>
<th data-quarto-table-cell-role="th">p_strength_lr</th>
<th data-quarto-table-cell-role="th">p_endurance_lr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>...</td>
<td>1.0</td>
<td>0</td>
<td>0.013031</td>
<td>0.011433</td>
<td>0.012512</td>
<td>0.013031</td>
<td>0.012601</td>
<td>0.013298</td>
<td>0.014615</td>
<td>0.015700</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>U3</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>45 to 59</td>
<td>no</td>
<td>35000</td>
<td>22</td>
<td>1.0</td>
<td>0</td>
<td>...</td>
<td>0.0</td>
<td>0</td>
<td>0.005123</td>
<td>0.004645</td>
<td>0.005086</td>
<td>0.005299</td>
<td>0.005123</td>
<td>0.005408</td>
<td>0.005949</td>
<td>0.006395</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>...</td>
<td>1.0</td>
<td>0</td>
<td>0.011948</td>
<td>0.008692</td>
<td>0.009515</td>
<td>0.009910</td>
<td>0.009582</td>
<td>0.010114</td>
<td>0.011120</td>
<td>0.011948</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>...</td>
<td>1.0</td>
<td>0</td>
<td>0.002361</td>
<td>0.002027</td>
<td>0.002220</td>
<td>0.002313</td>
<td>0.002236</td>
<td>0.002361</td>
<td>0.002598</td>
<td>0.002793</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>U25</td>
<td>no</td>
<td>0</td>
<td>racquet</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>32</td>
<td>1.1</td>
<td>1</td>
<td>...</td>
<td>0.0</td>
<td>0</td>
<td>0.011717</td>
<td>0.010706</td>
<td>0.011717</td>
<td>0.012203</td>
<td>0.011800</td>
<td>0.012453</td>
<td>0.013688</td>
<td>0.014705</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>...</td>
<td>1.0</td>
<td>0</td>
<td>0.002182</td>
<td>0.001873</td>
<td>0.002052</td>
<td>0.002138</td>
<td>0.002067</td>
<td>0.002182</td>
<td>0.002401</td>
<td>0.002582</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599996</td>
<td>U3462900</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>3</td>
<td>...</td>
<td>0.0</td>
<td>0</td>
<td>0.007347</td>
<td>0.006442</td>
<td>0.007053</td>
<td>0.007347</td>
<td>0.007103</td>
<td>0.007499</td>
<td>0.008247</td>
<td>0.008863</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>...</td>
<td>1.0</td>
<td>0</td>
<td>0.009142</td>
<td>0.008017</td>
<td>0.008776</td>
<td>0.009142</td>
<td>0.008839</td>
<td>0.009330</td>
<td>0.010258</td>
<td>0.011023</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599998</td>
<td>U3462916</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>50000</td>
<td>35</td>
<td>0.6</td>
<td>2</td>
<td>...</td>
<td>0.0</td>
<td>0</td>
<td>0.006615</td>
<td>0.005799</td>
<td>0.006350</td>
<td>0.006615</td>
<td>0.006395</td>
<td>0.006751</td>
<td>0.007425</td>
<td>0.007981</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599999</td>
<td>U3462922</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>30 to 44</td>
<td>yes</td>
<td>50000</td>
<td>25</td>
<td>0.7</td>
<td>1</td>
<td>...</td>
<td>0.0</td>
<td>0</td>
<td>0.010293</td>
<td>0.007484</td>
<td>0.008194</td>
<td>0.008535</td>
<td>0.008252</td>
<td>0.008710</td>
<td>0.009578</td>
<td>0.010293</td>
</tr>
</tbody>
</table>

<p>600000 rows × 25 columns</p>
</div>
</div>
</div>
</div>
<p>We then extend the prediction to the full database and see how the predictions are distributed.</p>
<div id="a1d1e9e8" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message_lr"</span>] <span class="op">=</span> pentathlon_nptb[[</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_lr"</span>, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_lr"</span>, </span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_lr"</span>, </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_lr"</span>, </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_lr"</span>, </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_lr"</span>, </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_lr"</span>]].idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message_lr"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>message_lr
p_endurance_lr    600000
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>After checking the distribution, we can see that the model predicts that every customer should be sent the same product. The mistake in the analysis above was that the specified model is not sufficiently flexible to allow customization across customers!</p>
<p>The output of the logistic regression above shows that there are indeed some interaction effects taking place in the data. We want to create a model that can capture these interaction effects, which we have done. We are now going to use the model to predict the next product to buy for the full database.</p>
<div id="73dba432" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>ivar<span class="op">=</span>[<span class="ss">f"</span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">:message"</span> <span class="cf">for</span> e <span class="kw">in</span> evar <span class="cf">if</span> e <span class="op">!=</span> <span class="st">"message"</span>]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>ivar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>['age:message',
 'female:message',
 'income:message',
 'education:message',
 'children:message',
 'freq_endurance:message',
 'freq_strength:message',
 'freq_water:message',
 'freq_team:message',
 'freq_backcountry:message',
 'freq_racquet:message']</code></pre>
</div>
</div>
<section id="the-model-is-then" class="level4">
<h4 class="anchored" data-anchor-id="the-model-is-then">The model is then:</h4>
<div id="ca81f35f" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>lr_int <span class="op">=</span> rsm.model.logistic(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"penathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    rvar<span class="op">=</span><span class="st">"buyer"</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    lev<span class="op">=</span><span class="st">"yes"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    evar<span class="op">=</span>evar,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    ivar<span class="op">=</span>ivar</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>lr_int.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Logistic regression (GLM)
Data                 : penathlon_nptb
Response variable    : buyer
Level                : yes
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Null hyp.: There is no effect of x on buyer
Alt. hyp.: There is an effect of x on buyer

                                        OR      OR%  coefficient  std.error  z.value p.value     
Intercept                            0.000  -100.0%        -8.25      0.153  -53.948  &lt; .001  ***
message[control]                     1.115    11.5%         0.11      0.220    0.496    0.62     
message[endurance]                   1.199    19.9%         0.18      0.213    0.850   0.395     
message[racquet]                     1.084     8.4%         0.08      0.217    0.370   0.711     
message[strength]                    0.959    -4.1%        -0.04      0.216   -0.195   0.846     
message[team]                        0.881   -11.9%        -0.13      0.217   -0.581   0.561     
message[water]                       0.903    -9.7%        -0.10      0.219   -0.468    0.64     
age[30 to 44]                        1.979    97.9%         0.68      0.100    6.802  &lt; .001  ***
age[45 to 59]                        2.056   105.6%         0.72      0.102    7.033  &lt; .001  ***
age[&gt;= 60]                           0.992    -0.8%        -0.01      0.127   -0.060   0.952     
female[no]                           1.365    36.5%         0.31      0.064    4.833  &lt; .001  ***
age[30 to 44]:message[control]       1.196    19.6%         0.18      0.146    1.225    0.22     
age[45 to 59]:message[control]       1.016     1.6%         0.02      0.150    0.107   0.914     
age[&gt;= 60]:message[control]          1.155    15.5%         0.14      0.184    0.785   0.432     
age[30 to 44]:message[endurance]     1.302    30.2%         0.26      0.142    1.855   0.064    .
age[45 to 59]:message[endurance]     1.142    14.2%         0.13      0.146    0.907   0.364     
age[&gt;= 60]:message[endurance]        1.473    47.3%         0.39      0.176    2.203   0.028    *
age[30 to 44]:message[racquet]       1.053     5.3%         0.05      0.144    0.358    0.72     
age[45 to 59]:message[racquet]       1.004     0.4%         0.00      0.147    0.030   0.976     
age[&gt;= 60]:message[racquet]          1.269    26.9%         0.24      0.178    1.334   0.182     
age[30 to 44]:message[strength]      1.307    30.7%         0.27      0.142    1.886   0.059    .
age[45 to 59]:message[strength]      0.947    -5.3%        -0.05      0.146   -0.375   0.708     
age[&gt;= 60]:message[strength]         1.084     8.4%         0.08      0.178    0.456   0.649     
age[30 to 44]:message[team]          1.268    26.8%         0.24      0.144    1.654   0.098    .
age[45 to 59]:message[team]          1.111    11.1%         0.10      0.147    0.713   0.476     
age[&gt;= 60]:message[team]             1.164    16.4%         0.15      0.180    0.841     0.4     
age[30 to 44]:message[water]         1.359    35.9%         0.31      0.147    2.081   0.037    *
age[45 to 59]:message[water]         1.264    26.4%         0.23      0.151    1.552   0.121     
age[&gt;= 60]:message[water]            1.362    36.2%         0.31      0.184    1.677   0.094    .
female[no]:message[control]          0.974    -2.6%        -0.03      0.092   -0.283   0.777     
female[no]:message[endurance]        0.884   -11.6%        -0.12      0.089   -1.391   0.164     
female[no]:message[racquet]          1.192    19.2%         0.18      0.092    1.911   0.056    .
female[no]:message[strength]         1.015     1.5%         0.02      0.090    0.168   0.867     
female[no]:message[team]             1.019     1.9%         0.02      0.090    0.206   0.837     
female[no]:message[water]            0.897   -10.3%        -0.11      0.091   -1.190   0.234     
income                               1.000     0.0%         0.00      0.000    8.324  &lt; .001  ***
income:message[control]              1.000     0.0%         0.00      0.000    0.020   0.984     
income:message[endurance]            1.000     0.0%         0.00      0.000    1.688   0.091    .
income:message[racquet]              1.000     0.0%         0.00      0.000    0.191   0.849     
income:message[strength]             1.000    -0.0%        -0.00      0.000   -0.368   0.713     
income:message[team]                 1.000     0.0%         0.00      0.000    0.053   0.958     
income:message[water]                1.000    -0.0%        -0.00      0.000   -0.353   0.724     
education                            1.041     4.1%         0.04      0.003   13.546  &lt; .001  ***
education:message[control]           0.995    -0.5%        -0.01      0.004   -1.273   0.203     
education:message[endurance]         0.993    -0.7%        -0.01      0.004   -1.722   0.085    .
education:message[racquet]           0.992    -0.8%        -0.01      0.004   -1.959    0.05    .
education:message[strength]          1.002     0.2%         0.00      0.004    0.551   0.581     
education:message[team]              1.000    -0.0%        -0.00      0.004   -0.071   0.943     
education:message[water]             0.997    -0.3%        -0.00      0.004   -0.718   0.473     
children                             1.723    72.3%         0.54      0.078    6.982  &lt; .001  ***
children:message[control]            0.838   -16.2%        -0.18      0.114   -1.552   0.121     
children:message[endurance]          0.885   -11.5%        -0.12      0.109   -1.120   0.263     
children:message[racquet]            0.933    -6.7%        -0.07      0.110   -0.629   0.529     
children:message[strength]           1.023     2.3%         0.02      0.110    0.207   0.836     
children:message[team]               0.960    -4.0%        -0.04      0.111   -0.369   0.712     
children:message[water]              0.935    -6.5%        -0.07      0.112   -0.602   0.547     
freq_endurance                       1.081     8.1%         0.08      0.014    5.617  &lt; .001  ***
freq_endurance:message[control]      1.029     2.9%         0.03      0.020    1.442   0.149     
freq_endurance:message[endurance]    0.990    -1.0%        -0.01      0.020   -0.512   0.609     
freq_endurance:message[racquet]      1.016     1.6%         0.02      0.020    0.792   0.428     
freq_endurance:message[strength]     1.016     1.6%         0.02      0.020    0.804   0.421     
freq_endurance:message[team]         1.043     4.3%         0.04      0.019    2.157   0.031    *
freq_endurance:message[water]        1.036     3.6%         0.04      0.020    1.807   0.071    .
freq_strength                        1.114    11.4%         0.11      0.009   12.347  &lt; .001  ***
freq_strength:message[control]       1.001     0.1%         0.00      0.012    0.045   0.964     
freq_strength:message[endurance]     0.991    -0.9%        -0.01      0.012   -0.732   0.464     
freq_strength:message[racquet]       1.002     0.2%         0.00      0.012    0.142   0.887     
freq_strength:message[strength]      0.998    -0.2%        -0.00      0.012   -0.174   0.862     
freq_strength:message[team]          1.003     0.3%         0.00      0.012    0.249   0.803     
freq_strength:message[water]         1.015     1.5%         0.01      0.012    1.162   0.245     
freq_water                           1.139    13.9%         0.13      0.035    3.678  &lt; .001  ***
freq_water:message[control]          1.036     3.6%         0.04      0.051    0.699   0.484     
freq_water:message[endurance]        1.067     6.7%         0.06      0.051    1.272   0.204     
freq_water:message[racquet]          1.028     2.8%         0.03      0.051    0.539    0.59     
freq_water:message[strength]         1.014     1.4%         0.01      0.051    0.268   0.788     
freq_water:message[team]             0.970    -3.0%        -0.03      0.050   -0.602   0.547     
freq_water:message[water]            1.158    15.8%         0.15      0.051    2.859   0.004   **
freq_team                            1.037     3.7%         0.04      0.012    3.069   0.002   **
freq_team:message[control]           1.005     0.5%         0.01      0.017    0.302   0.763     
freq_team:message[endurance]         0.999    -0.1%        -0.00      0.017   -0.057   0.955     
freq_team:message[racquet]           1.025     2.5%         0.02      0.017    1.431   0.152     
freq_team:message[strength]          1.031     3.1%         0.03      0.017    1.788   0.074    .
freq_team:message[team]              0.993    -0.7%        -0.01      0.017   -0.406   0.685     
freq_team:message[water]             1.036     3.6%         0.04      0.017    2.081   0.037    *
freq_backcountry                     1.210    21.0%         0.19      0.026    7.256  &lt; .001  ***
freq_backcountry:message[control]    0.973    -2.7%        -0.03      0.037   -0.727   0.467     
freq_backcountry:message[endurance]  0.992    -0.8%        -0.01      0.037   -0.224   0.823     
freq_backcountry:message[racquet]    0.968    -3.2%        -0.03      0.037   -0.864   0.388     
freq_backcountry:message[strength]   0.982    -1.8%        -0.02      0.037   -0.492   0.623     
freq_backcountry:message[team]       0.976    -2.4%        -0.02      0.037   -0.658   0.511     
freq_backcountry:message[water]      0.981    -1.9%        -0.02      0.038   -0.517   0.605     
freq_racquet                         1.100    10.0%         0.10      0.017    5.456  &lt; .001  ***
freq_racquet:message[control]        1.034     3.4%         0.03      0.025    1.356   0.175     
freq_racquet:message[endurance]      1.034     3.4%         0.03      0.025    1.375   0.169     
freq_racquet:message[racquet]        1.039     3.9%         0.04      0.025    1.523   0.128     
freq_racquet:message[strength]       0.975    -2.5%        -0.03      0.025   -1.023   0.306     
freq_racquet:message[team]           0.992    -0.8%        -0.01      0.024   -0.345    0.73     
freq_racquet:message[water]          0.998    -0.2%        -0.00      0.025   -0.090   0.928     

Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Pseudo R-squared (McFadden): 0.262
Pseudo R-squared (McFadden adjusted): 0.26
Area under the RO Curve (AUC): 0.884
Log-likelihood: -35102.941, AIC: 70401.883, BIC: 71474.788
Chi-squared: 24901.02, df(97), p.value &lt; 0.001 
Nr obs: 420,000</code></pre>
</div>
</div>
<div id="e0434c9a" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pred_lr_int"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b29675df" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dct <span class="op">=</span> {<span class="st">"train"</span>: pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"test"</span>: pentathlon_nptb.query(<span class="st">"training == 0"</span>)}</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> rsm.gains_plot(dct, <span class="st">"buyer"</span>, <span class="st">"yes"</span>, <span class="st">"pred_lr_int"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-35-output-1.png" width="606" height="429" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="05154b54" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> rsm.gains_plot(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"buyer"</span>, <span class="st">"yes"</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"pred_lr"</span>, <span class="st">"pred_lr_int"</span>]</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-36-output-1.png" width="606" height="429" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8cf16fb8" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on training set</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">'pred_lr_int'</span>]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">'buyer_yes'</span>]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual, pred)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0.884</code></pre>
</div>
</div>
<div id="762da491" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on test set</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">'pred_lr_int'</span>]</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">'buyer_yes'</span>]</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual, pred)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>0.883</code></pre>
</div>
</div>
<p>Now, lets repeat the analysis above with the new model.</p>
<div id="291a9e83" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_controli_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_racqueti_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_teami_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_backcountryi_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_wateri_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_strengthi_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_endurancei_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">p_endurance_lr</th>
<th data-quarto-table-cell-role="th">message_lr</th>
<th data-quarto-table-cell-role="th">pred_lr_int</th>
<th data-quarto-table-cell-role="th">p_controli_lr</th>
<th data-quarto-table-cell-role="th">p_racqueti_lr</th>
<th data-quarto-table-cell-role="th">p_teami_lr</th>
<th data-quarto-table-cell-role="th">p_backcountryi_lr</th>
<th data-quarto-table-cell-role="th">p_wateri_lr</th>
<th data-quarto-table-cell-role="th">p_strengthi_lr</th>
<th data-quarto-table-cell-role="th">p_endurancei_lr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>...</td>
<td>0.015700</td>
<td>p_endurance_lr</td>
<td>0.012008</td>
<td>0.012022</td>
<td>0.014499</td>
<td>0.012008</td>
<td>0.011131</td>
<td>0.012604</td>
<td>0.015452</td>
<td>0.015682</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>U3</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>45 to 59</td>
<td>no</td>
<td>35000</td>
<td>22</td>
<td>1.0</td>
<td>0</td>
<td>...</td>
<td>0.006395</td>
<td>p_endurance_lr</td>
<td>0.005556</td>
<td>0.004605</td>
<td>0.005858</td>
<td>0.005279</td>
<td>0.005556</td>
<td>0.004981</td>
<td>0.005475</td>
<td>0.006014</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>...</td>
<td>0.011948</td>
<td>p_endurance_lr</td>
<td>0.013884</td>
<td>0.009140</td>
<td>0.008789</td>
<td>0.009533</td>
<td>0.010718</td>
<td>0.009680</td>
<td>0.009343</td>
<td>0.013884</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>...</td>
<td>0.002793</td>
<td>p_endurance_lr</td>
<td>0.002389</td>
<td>0.002252</td>
<td>0.002089</td>
<td>0.002264</td>
<td>0.002339</td>
<td>0.002389</td>
<td>0.002196</td>
<td>0.002970</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>U25</td>
<td>no</td>
<td>0</td>
<td>racquet</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>32</td>
<td>1.1</td>
<td>1</td>
<td>...</td>
<td>0.014705</td>
<td>p_endurance_lr</td>
<td>0.012039</td>
<td>0.010784</td>
<td>0.012039</td>
<td>0.011119</td>
<td>0.011526</td>
<td>0.011437</td>
<td>0.011463</td>
<td>0.019675</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>...</td>
<td>0.002582</td>
<td>p_endurance_lr</td>
<td>0.002042</td>
<td>0.001966</td>
<td>0.002118</td>
<td>0.001946</td>
<td>0.001947</td>
<td>0.002042</td>
<td>0.002089</td>
<td>0.003217</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599996</td>
<td>U3462900</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>3</td>
<td>...</td>
<td>0.008863</td>
<td>p_endurance_lr</td>
<td>0.007692</td>
<td>0.006959</td>
<td>0.008257</td>
<td>0.007692</td>
<td>0.007884</td>
<td>0.005832</td>
<td>0.008117</td>
<td>0.007731</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>...</td>
<td>0.011023</td>
<td>p_endurance_lr</td>
<td>0.008225</td>
<td>0.008535</td>
<td>0.008976</td>
<td>0.008225</td>
<td>0.010062</td>
<td>0.008286</td>
<td>0.009822</td>
<td>0.011345</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599998</td>
<td>U3462916</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>50000</td>
<td>35</td>
<td>0.6</td>
<td>2</td>
<td>...</td>
<td>0.007981</td>
<td>p_endurance_lr</td>
<td>0.006796</td>
<td>0.006378</td>
<td>0.007352</td>
<td>0.006796</td>
<td>0.007164</td>
<td>0.005272</td>
<td>0.007284</td>
<td>0.006971</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599999</td>
<td>U3462922</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>30 to 44</td>
<td>yes</td>
<td>50000</td>
<td>25</td>
<td>0.7</td>
<td>1</td>
<td>...</td>
<td>0.010293</td>
<td>p_endurance_lr</td>
<td>0.011857</td>
<td>0.008527</td>
<td>0.007495</td>
<td>0.008401</td>
<td>0.007500</td>
<td>0.008214</td>
<td>0.009222</td>
<td>0.011857</td>
</tr>
</tbody>
</table>

<p>600000 rows × 34 columns</p>
</div>
</div>
</div>
</div>
<p>We then extend the prediction to the full database and see how the predictions are distributed.</p>
<div id="2b093078" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_controli_lr"</span>: <span class="st">"control"</span>, </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurancei_lr"</span>: <span class="st">"endurance"</span>, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountryi_lr"</span>: <span class="st">"backcountry"</span>, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racqueti_lr"</span>: <span class="st">"racquet"</span>, </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strengthi_lr"</span>: <span class="st">"strength"</span>, </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_teami_lr"</span>: <span class="st">"team"</span>, </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_wateri_lr"</span>: <span class="st">"water"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ffa4a860" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>predictions_lr <span class="op">=</span> [</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_controli_lr"</span>, </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurancei_lr"</span>, </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountryi_lr"</span>, </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racqueti_lr"</span>, </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strengthi_lr"</span>, </span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_teami_lr"</span>, </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_wateri_lr"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="find-the-highest-probability-of-purchase-for-each-customer-labeled-them-by-the-product-with-the-highest-probability-of-purchase" class="level4">
<h4 class="anchored" data-anchor-id="find-the-highest-probability-of-purchase-for-each-customer-labeled-them-by-the-product-with-the-highest-probability-of-purchase">Find the highest probability of purchase for each customer, labeled them by the product with the highest probability of purchase</h4>
<div id="3c6e12c2" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"messagei_lr"</span>] <span class="op">=</span> (</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[predictions_lr]</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">message_lr</th>
<th data-quarto-table-cell-role="th">pred_lr_int</th>
<th data-quarto-table-cell-role="th">p_controli_lr</th>
<th data-quarto-table-cell-role="th">p_racqueti_lr</th>
<th data-quarto-table-cell-role="th">p_teami_lr</th>
<th data-quarto-table-cell-role="th">p_backcountryi_lr</th>
<th data-quarto-table-cell-role="th">p_wateri_lr</th>
<th data-quarto-table-cell-role="th">p_strengthi_lr</th>
<th data-quarto-table-cell-role="th">p_endurancei_lr</th>
<th data-quarto-table-cell-role="th">messagei_lr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.012008</td>
<td>0.012022</td>
<td>0.014499</td>
<td>0.012008</td>
<td>0.011131</td>
<td>0.012604</td>
<td>0.015452</td>
<td>0.015682</td>
<td>endurance</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>U3</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>45 to 59</td>
<td>no</td>
<td>35000</td>
<td>22</td>
<td>1.0</td>
<td>0</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.005556</td>
<td>0.004605</td>
<td>0.005858</td>
<td>0.005279</td>
<td>0.005556</td>
<td>0.004981</td>
<td>0.005475</td>
<td>0.006014</td>
<td>endurance</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.013884</td>
<td>0.009140</td>
<td>0.008789</td>
<td>0.009533</td>
<td>0.010718</td>
<td>0.009680</td>
<td>0.009343</td>
<td>0.013884</td>
<td>endurance</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.002389</td>
<td>0.002252</td>
<td>0.002089</td>
<td>0.002264</td>
<td>0.002339</td>
<td>0.002389</td>
<td>0.002196</td>
<td>0.002970</td>
<td>endurance</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>U25</td>
<td>no</td>
<td>0</td>
<td>racquet</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>32</td>
<td>1.1</td>
<td>1</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.012039</td>
<td>0.010784</td>
<td>0.012039</td>
<td>0.011119</td>
<td>0.011526</td>
<td>0.011437</td>
<td>0.011463</td>
<td>0.019675</td>
<td>endurance</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.002042</td>
<td>0.001966</td>
<td>0.002118</td>
<td>0.001946</td>
<td>0.001947</td>
<td>0.002042</td>
<td>0.002089</td>
<td>0.003217</td>
<td>endurance</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599996</td>
<td>U3462900</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>3</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.007692</td>
<td>0.006959</td>
<td>0.008257</td>
<td>0.007692</td>
<td>0.007884</td>
<td>0.005832</td>
<td>0.008117</td>
<td>0.007731</td>
<td>racquet</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.008225</td>
<td>0.008535</td>
<td>0.008976</td>
<td>0.008225</td>
<td>0.010062</td>
<td>0.008286</td>
<td>0.009822</td>
<td>0.011345</td>
<td>endurance</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599998</td>
<td>U3462916</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>50000</td>
<td>35</td>
<td>0.6</td>
<td>2</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.006796</td>
<td>0.006378</td>
<td>0.007352</td>
<td>0.006796</td>
<td>0.007164</td>
<td>0.005272</td>
<td>0.007284</td>
<td>0.006971</td>
<td>racquet</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599999</td>
<td>U3462922</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>30 to 44</td>
<td>yes</td>
<td>50000</td>
<td>25</td>
<td>0.7</td>
<td>1</td>
<td>...</td>
<td>p_endurance_lr</td>
<td>0.011857</td>
<td>0.008527</td>
<td>0.007495</td>
<td>0.008401</td>
<td>0.007500</td>
<td>0.008214</td>
<td>0.009222</td>
<td>0.011857</td>
<td>endurance</td>
</tr>
</tbody>
</table>

<p>600000 rows × 35 columns</p>
</div>
</div>
</div>
</div>
<div id="562aa280" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the maximum probability of purchase</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_max"</span>] <span class="op">=</span> pentathlon_nptb[predictions_lr].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Approach: First of all, We build a logistic regression model to predict the next product to buy, use buyer_yes as the response variable and the other variables as predictors. After relizing that the model predicts that every customer should be sent the same product i.e, <code>endurance</code>, we build another model that can capture these interaction effects.</p>
<p>We then extend the prediction to the full database. To predict the probability of purchasing for different messages, we use the <code>data_cmd</code> to predict the probability of purchasing for different messages.</p>
<p>Finally, we choose the product with the highest probability using <code>idxmax</code> to automatically find the best message for each customer. This command also provides a label for the category with the maximum predicted propability of buying accross all the products. Then, create <code>p_max</code> to store the maximum predicted probability of purchasing for the best message sellected for each customer.</p>
</section>
<section id="for-each-message-report-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase" class="level4">
<h4 class="anchored" data-anchor-id="for-each-message-report-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase">2. For each message, report the percentage of customers for whom that message or no-message maximizes their probability of purchase</h4>
<p>Let’s create a <code>crosstab</code> to see which products should we send to each customer.</p>
<div id="f830002b" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].messagei_lr, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">messagei_lr</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>1,447</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">endurance</td>
<td>125,861</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">racquet</td>
<td>12,299</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">strength</td>
<td>36,584</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">team</td>
<td>1,680</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">water</td>
<td>2,129</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Report the percentage of customers for whom that message is the best message or not the best message.</p>
<div id="e9251ea0" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"messagei_lr"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>messagei_lr
endurance      0.699675
strength       0.202202
racquet        0.069037
water          0.011852
team           0.009358
backcountry    0.007875
control        0.000002
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<ul>
<li><p><code>edurance</code>: The distribution suggests that <code>endurance</code> - related messages resonate significantly more with the customers than the other messages.</p></li>
<li><p><code>strength</code>: Wilte not as dominant as <code>endurance</code>, <code>strength</code> - related messages also play an important role. There might be opportunities to further optimize or tailor these messages to increase their effectiveness.</p></li>
<li><p>Other categories such as <code>racquet</code>, <code>water</code>, <code>team</code>, <code>backcountry</code> have much smaller proportions, suggesting that they are less often the best choice for maximizing the probability of purchase.</p></li>
<li><p><code>control</code>: The negligible role of <code>control</code> in maximizing the probability suggrest that any engagement, even if not perfectly oplimized, tends to be better than no engagement at all. However, it’s also essential to consider the context and the potential costs of sending messages to customers.</p></li>
</ul>
<p>Create a table with the average purchase probability if we send the message for each product to everyone.</p>
<div id="47f046bc" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, predictions_lr].agg(<span class="st">"mean"</span>).sort_values(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(rsm.format_nr, perc<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>p_endurancei_lr      2.79%
p_strengthi_lr       2.64%
p_wateri_lr          2.44%
p_teami_lr           2.39%
p_backcountryi_lr    2.32%
p_racqueti_lr        2.31%
p_controli_lr        2.14%
dtype: object</code></pre>
</div>
</div>
</section>
<section id="expected-profit" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit">3. Expected profit</h4>
<div id="6ee40e8f" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the actual order size</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>ordersize <span class="op">=</span> pentathlon_nptb[(pentathlon_nptb.training <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pentathlon_nptb.buyer_yes <span class="op">==</span> <span class="dv">1</span>)].groupby(<span class="st">"message"</span>)[<span class="st">"total_os"</span>].mean()</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>ordersize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/476348601.py:2: FutureWarning:

The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>message
backcountry    64.034091
control        49.900598
endurance      55.584893
racquet        56.405620
strength       56.708751
team           56.522449
water          61.957343
Name: total_os, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="creat-linear-model-to-predict-ordersize" class="level4">
<h4 class="anchored" data-anchor-id="creat-linear-model-to-predict-ordersize">Creat Linear model to predict ordersize</h4>
<div id="f3822057" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> rsm.model.regress(</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[(pentathlon_nptb.training <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pentathlon_nptb.buyer <span class="op">==</span> <span class="st">"yes"</span>)]},</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    rvar <span class="op">=</span><span class="st">"total_os"</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    evar <span class="op">=</span> evar,</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    ivar <span class="op">=</span> ivar</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>reg.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear regression (OLS)
Data                 : pentathlon_nptb
Response variable    : total_os
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Null hyp.: the effect of x on total_os is zero
Alt. hyp.: the effect of x on total_os is not zero

                                     coefficient  std.error  t.value p.value     
Intercept                                 -9.616      8.976   -1.071   0.284     
message[control]                          17.412     12.953    1.344   0.179     
message[endurance]                         9.106     12.058    0.755    0.45     
message[racquet]                           4.179     12.822    0.326   0.745     
message[strength]                          1.414     12.601    0.112   0.911     
message[team]                             10.566     12.573    0.840   0.401     
message[water]                             6.659     12.905    0.516   0.606     
age[30 to 44]                              4.166      5.701    0.731   0.465     
age[45 to 59]                              6.059      5.712    1.061   0.289     
age[&gt;= 60]                                -0.679      7.066   -0.096   0.923     
female[no]                                 3.578      3.548    1.008   0.313     
age[30 to 44]:message[control]            -6.037      8.297   -0.728   0.467     
age[45 to 59]:message[control]            -3.440      8.437   -0.408   0.683     
age[&gt;= 60]:message[control]                5.342     10.292    0.519   0.604     
age[30 to 44]:message[endurance]          -3.088      8.017   -0.385     0.7     
age[45 to 59]:message[endurance]         -12.434      8.132   -1.529   0.126     
age[&gt;= 60]:message[endurance]              6.071      9.755    0.622   0.534     
age[30 to 44]:message[racquet]            -1.337      8.176   -0.163    0.87     
age[45 to 59]:message[racquet]            -8.117      8.242   -0.985   0.325     
age[&gt;= 60]:message[racquet]               -5.150     10.010   -0.514   0.607     
age[30 to 44]:message[strength]           -0.696      7.975   -0.087    0.93     
age[45 to 59]:message[strength]            0.160      8.076    0.020   0.984     
age[&gt;= 60]:message[strength]               5.451      9.893    0.551   0.582     
age[30 to 44]:message[team]                8.784      8.077    1.088   0.277     
age[45 to 59]:message[team]                6.381      8.161    0.782   0.434     
age[&gt;= 60]:message[team]                   9.798     10.020    0.978   0.328     
age[30 to 44]:message[water]              -7.117      8.285   -0.859    0.39     
age[45 to 59]:message[water]             -12.193      8.378   -1.455   0.146     
age[&gt;= 60]:message[water]                  5.907     10.209    0.579   0.563     
female[no]:message[control]               -4.082      5.058   -0.807    0.42     
female[no]:message[endurance]             -3.209      4.877   -0.658   0.511     
female[no]:message[racquet]               -2.000      5.096   -0.392   0.695     
female[no]:message[strength]              -3.970      4.920   -0.807    0.42     
female[no]:message[team]                  -8.944      4.904   -1.824   0.068    .
female[no]:message[water]                  1.978      4.972    0.398   0.691     
income                                     0.000      0.000    3.970  &lt; .001  ***
income:message[control]                   -0.000      0.000   -1.166   0.244     
income:message[endurance]                 -0.000      0.000   -0.710   0.478     
income:message[racquet]                    0.000      0.000    0.702   0.483     
income:message[strength]                  -0.000      0.000   -1.205   0.228     
income:message[team]                      -0.000      0.000   -1.392   0.164     
income:message[water]                     -0.000      0.000   -1.353   0.176     
education                                  0.773      0.161    4.812  &lt; .001  ***
education:message[control]                -0.370      0.230   -1.613   0.107     
education:message[endurance]              -0.238      0.218   -1.090   0.276     
education:message[racquet]                -0.292      0.228   -1.283   0.199     
education:message[strength]                0.005      0.221    0.025    0.98     
education:message[team]                   -0.337      0.224   -1.505   0.132     
education:message[water]                  -0.088      0.226   -0.390   0.696     
children                                   7.307      4.406    1.659   0.097    .
children:message[control]                  4.666      6.217    0.750   0.453     
children:message[endurance]                1.572      5.994    0.262   0.793     
children:message[racquet]                  5.236      6.255    0.837   0.403     
children:message[strength]                -0.699      6.269   -0.112   0.911     
children:message[team]                     4.814      6.233    0.772    0.44     
children:message[water]                   11.040      6.482    1.703   0.089    .
freq_endurance                            -1.400      0.698   -2.004   0.045    *
freq_endurance:message[control]            1.082      0.995    1.088   0.277     
freq_endurance:message[endurance]         -0.138      0.974   -0.142   0.887     
freq_endurance:message[racquet]           -0.927      1.005   -0.922   0.356     
freq_endurance:message[strength]           0.160      0.981    0.163   0.871     
freq_endurance:message[team]               1.424      0.963    1.479   0.139     
freq_endurance:message[water]             -0.298      0.968   -0.308   0.758     
freq_strength                             -2.181      0.437   -4.988  &lt; .001  ***
freq_strength:message[control]             0.352      0.626    0.563   0.573     
freq_strength:message[endurance]           0.286      0.607    0.471   0.638     
freq_strength:message[racquet]             0.029      0.635    0.045   0.964     
freq_strength:message[strength]            1.337      0.614    2.179   0.029    *
freq_strength:message[team]                0.807      0.615    1.312    0.19     
freq_strength:message[water]               1.055      0.614    1.718   0.086    .
freq_water                                 2.979      1.679    1.774   0.076    .
freq_water:message[control]                0.263      2.417    0.109   0.913     
freq_water:message[endurance]             -1.171      2.375   -0.493   0.622     
freq_water:message[racquet]               -2.418      2.392   -1.011   0.312     
freq_water:message[strength]               0.200      2.369    0.084   0.933     
freq_water:message[team]                  -1.236      2.347   -0.527   0.598     
freq_water:message[water]                 -3.641      2.368   -1.538   0.124     
freq_team                                 -0.075      0.599   -0.125   0.901     
freq_team:message[control]                -0.229      0.847   -0.270   0.787     
freq_team:message[endurance]               2.188      0.829    2.638   0.008   **
freq_team:message[racquet]                -0.563      0.861   -0.654   0.513     
freq_team:message[strength]               -0.657      0.850   -0.774   0.439     
freq_team:message[team]                    0.320      0.829    0.386     0.7     
freq_team:message[water]                  -0.932      0.836   -1.115   0.265     
freq_backcountry                           2.686      1.320    2.035   0.042    *
freq_backcountry:message[control]         -0.962      1.902   -0.506   0.613     
freq_backcountry:message[endurance]        2.745      1.848    1.486   0.137     
freq_backcountry:message[racquet]         -0.198      1.887   -0.105   0.916     
freq_backcountry:message[strength]        -0.097      1.864   -0.052   0.958     
freq_backcountry:message[team]            -0.529      1.858   -0.284   0.776     
freq_backcountry:message[water]            1.071      1.862    0.575   0.565     
freq_racquet                               0.297      0.868    0.343   0.732     
freq_racquet:message[control]             -0.775      1.246   -0.622   0.534     
freq_racquet:message[endurance]           -0.021      1.186   -0.018   0.986     
freq_racquet:message[racquet]              0.944      1.237    0.764   0.445     
freq_racquet:message[strength]             1.148      1.200    0.957   0.339     
freq_racquet:message[team]                 0.199      1.207    0.165   0.869     
freq_racquet:message[water]                1.503      1.214    1.238   0.216     

Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-squared: 0.089, Adjusted R-squared: 0.08
F-statistic: 10.021 df(97, 9982), p.value &lt; 0.001
Nr obs: 10,080</code></pre>
</div>
</div>
<div id="9015976f" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>reg.coef.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">coefficient</th>
<th data-quarto-table-cell-role="th">std.error</th>
<th data-quarto-table-cell-role="th">t.value</th>
<th data-quarto-table-cell-role="th">p.value</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Intercept</td>
<td>-9.616</td>
<td>8.976</td>
<td>-1.071</td>
<td>0.284</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>message[T.control]</td>
<td>17.412</td>
<td>12.953</td>
<td>1.344</td>
<td>0.179</td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>message[T.endurance]</td>
<td>9.106</td>
<td>12.058</td>
<td>0.755</td>
<td>0.450</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>message[T.racquet]</td>
<td>4.179</td>
<td>12.822</td>
<td>0.326</td>
<td>0.745</td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>message[T.strength]</td>
<td>1.414</td>
<td>12.601</td>
<td>0.112</td>
<td>0.911</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">93</td>
<td>freq_racquet:message[T.endurance]</td>
<td>-0.021</td>
<td>1.186</td>
<td>-0.018</td>
<td>0.986</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">94</td>
<td>freq_racquet:message[T.racquet]</td>
<td>0.944</td>
<td>1.237</td>
<td>0.764</td>
<td>0.445</td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>freq_racquet:message[T.strength]</td>
<td>1.148</td>
<td>1.200</td>
<td>0.957</td>
<td>0.339</td>
<td></td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>freq_racquet:message[T.team]</td>
<td>0.199</td>
<td>1.207</td>
<td>0.165</td>
<td>0.869</td>
<td></td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>freq_racquet:message[T.water]</td>
<td>1.503</td>
<td>1.214</td>
<td>1.238</td>
<td>0.216</td>
<td></td>
</tr>
</tbody>
</table>

<p>98 rows × 6 columns</p>
</div>
</div>
</div>
</div>
<div id="3607cc53" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_control_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_racquet_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_team_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_backcountry_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_water_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_strength_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_endurance_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-the-expected-profit-for-each-product" class="level4">
<h4 class="anchored" data-anchor-id="calculate-the-expected-profit-for-each-product">Calculate the expected profit for each product</h4>
<div id="a481c942" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_control_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_control_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_control_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_racquet_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_racquet_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_racquet_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_team_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_team_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_team_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_backcountry_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_backcountry_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_backcountry_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_water_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_water_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_water_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_strength_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_strength_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_strength_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_endurance_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_endurance_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_endurance_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To determine the message to send that will maximize the expected profit, we can use the following formula:</p>
<div id="65481f0d" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>expected_profit_lr <span class="op">=</span> [</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_control_lr"</span>, </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_endurance_lr"</span>, </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_backcountry_lr"</span>, </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_racquet_lr"</span>, </span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_strength_lr"</span>, </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_team_lr"</span>, </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_water_lr"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ced269c5" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {<span class="st">"ep_control_lr"</span>: <span class="st">"control"</span>, <span class="st">"ep_endurance_lr"</span>: <span class="st">"endurance"</span>, <span class="st">"ep_backcountry_lr"</span>: <span class="st">"backcountry"</span>, <span class="st">"ep_racquet_lr"</span>: <span class="st">"racquet"</span>, <span class="st">"ep_strength_lr"</span>: <span class="st">"strength"</span>, <span class="st">"ep_team_lr"</span>: <span class="st">"team"</span>, <span class="st">"ep_water_lr"</span>: <span class="st">"water"</span>}</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_message_lr"</span>] <span class="op">=</span> (</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[expected_profit_lr]</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To predict the order size, we use the <code>total_os</code> as the response variable and the other variables as predictors as well as the interaction between message and other variables. We then extend the prediction to the full database and see how the predictions are distributed.</p>
<p>Same as the previous model, we use the <code>data_cmd</code> to predict the order size for different messages.</p>
<p>After that, we calculate the expected profit for each product by multiplying the probability of purchasing and the order size for each product. We then choose the product with the highest expected profit using <code>idxmax</code> to automatically find the best message for each customer. This command also provides a label for the category with the maximum expected profit. Then, create <code>p_max</code> to store the maximum expected profit of purchasing for the best message sellected for each customer.</p>
</section>
<section id="report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit." class="level4">
<h4 class="anchored" data-anchor-id="report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit.">4.Report for each message, i.e., endurance, racket, etc., and no-message, the percentage of customers for whom that (no) message maximizes their expected profit.</h4>
<div id="8c8ff2ce" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.ep_message_lr.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>ep_message_lr
water          0.340890
endurance      0.306053
team           0.206722
backcountry    0.073778
strength       0.066898
racquet        0.004322
control        0.001337
Name: proportion, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer">5. Expected profit can we obtain, on average, per customer if we customize the message to each customer?</h4>
<div id="fb4daefe" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max"</span>] <span class="op">=</span> pentathlon_nptb[expected_profit_lr].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max"</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>0.6754439327865267</code></pre>
</div>
</div>
<p>Let create the crosstab</p>
<div id="c8ba5550" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].ep_message_lr, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ep_message_lr</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>13,379</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">control</td>
<td>238</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">endurance</td>
<td>54,956</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">racquet</td>
<td>740</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">strength</td>
<td>12,092</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">team</td>
<td>37,539</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">water</td>
<td>61,056</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message">6. Expected profit per e-mailed customer if every customer receives the same message</h4>
<div id="67951f5c" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    .loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, [<span class="st">"ep_control_lr"</span>, <span class="st">"ep_endurance_lr"</span>, <span class="st">"ep_backcountry_lr"</span>, <span class="st">"ep_racquet_lr"</span>, <span class="st">"ep_strength_lr"</span>, <span class="st">"ep_team_lr"</span>, <span class="st">"ep_water_lr"</span>]]</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    .agg(<span class="st">"mean"</span>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(rsm.format_nr, sym <span class="op">=</span> <span class="st">"$"</span>, dec <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>ep_endurance_lr      $0.62
ep_water_lr           $0.6
ep_strength_lr        $0.6
ep_backcountry_lr    $0.59
ep_team_lr           $0.54
ep_racquet_lr        $0.53
ep_control_lr        $0.43
dtype: object</code></pre>
</div>
</div>
</section>
</section>
<section id="expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition" class="level3">
<h3 class="anchored" data-anchor-id="expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition">7. Expected profit per e-mailed customer if every customer is assigned randomly to one of the messages or the no-message condition?</h3>
<div id="dc19b6e5" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probabilty of purchase where customer is assigned to a random message</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_random_lr"</span>] <span class="op">=</span> lr_int.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected avg order size where customer is assigned to a random message</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ordersize_random_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit where customer is assigned to a random message</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_random_lr"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_random_lr"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"ordersize_random_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit per customer where customer is assigned to a random message</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>random_profit_per_customer <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_random_lr"</span>].mean()</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>random_profit_per_customer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>0.5569904087502335</code></pre>
</div>
</div>
<div id="a02db956" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit where no-message is sent (control)</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_control_lr"</span>]</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit per customer where no-message is sent (control)</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_control_lr"</span>].mean()</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>0.4339519244630221</code></pre>
</div>
</div>
<section id="profit-for-5000000-customers" class="level4">
<h4 class="anchored" data-anchor-id="profit-for-5000000-customers">8. Profit for 5,000,000 customers</h4>
<div id="5bf868d2" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where each customer is assigned to the message with the highest expected profit</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>profit_logit <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_max"</span>].agg(<span class="st">"mean"</span>) <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>profit_logit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>3408166.566437483</code></pre>
</div>
</div>
<div id="7354716e" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where each customer is sent to a random message</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>random_profit <span class="op">=</span> random_profit_per_customer <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>random_profit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>2784952.0437511676</code></pre>
</div>
</div>
<div id="99f0b4cd" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where no message is sent</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>control_profit <span class="op">=</span> control_profit_per_customer <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>control_profit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>2169759.6223151106</code></pre>
</div>
</div>
<div id="31af3c6e" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>profit_improvement_lr <span class="op">=</span> profit_logit <span class="op">-</span> control_profit</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>profit_improvement_lr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>1238406.9441223722</code></pre>
</div>
</div>
<div id="be88ce34" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>profits_dct <span class="op">=</span> {</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Customize Message"</span>: profit_logit,</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Randomly Assign"</span>: random_profit,</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Message Sent"</span>: control_profit,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dictionary to DataFrame</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(profits_dct.items()), columns<span class="op">=</span>[<span class="st">'Model'</span>, <span class="st">'Profit'</span>])</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))  <span class="co"># Adjust the width and height to your preference</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"Model"</span>, y<span class="op">=</span><span class="st">"Profit"</span>, data<span class="op">=</span>df, palette<span class="op">=</span><span class="st">"magma"</span>)</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotations</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    ax.text(index, row.Profit, <span class="ss">f'$</span><span class="sc">{</span>row<span class="sc">.</span>Profit<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Model Type"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Profit"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Profit by Model"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">15</span>})</span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate x labels for better readability</span></span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1123293812.py:16: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-64-output-2.png" width="817" height="549" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="neural-networks-model" class="level2">
<h2 class="anchored" data-anchor-id="neural-networks-model">Neural Networks Model</h2>
<div id="1ae61d4f" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">ep_team_lr</th>
<th data-quarto-table-cell-role="th">ep_backcountry_lr</th>
<th data-quarto-table-cell-role="th">ep_water_lr</th>
<th data-quarto-table-cell-role="th">ep_strength_lr</th>
<th data-quarto-table-cell-role="th">ep_endurance_lr</th>
<th data-quarto-table-cell-role="th">ep_message_lr</th>
<th data-quarto-table-cell-role="th">ep_max</th>
<th data-quarto-table-cell-role="th">p_random_lr</th>
<th data-quarto-table-cell-role="th">ordersize_random_reg</th>
<th data-quarto-table-cell-role="th">ep_random_lr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>...</td>
<td>0.170065</td>
<td>0.152448</td>
<td>0.165323</td>
<td>0.127039</td>
<td>0.216326</td>
<td>endurance</td>
<td>0.216326</td>
<td>0.012008</td>
<td>32.627819</td>
<td>0.156712</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>...</td>
<td>0.197624</td>
<td>0.190290</td>
<td>0.186217</td>
<td>0.204221</td>
<td>0.194732</td>
<td>strength</td>
<td>0.204221</td>
<td>0.013884</td>
<td>40.744326</td>
<td>0.226274</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>...</td>
<td>0.028568</td>
<td>0.022970</td>
<td>0.014892</td>
<td>0.024216</td>
<td>0.016298</td>
<td>team</td>
<td>0.028568</td>
<td>0.002389</td>
<td>15.768889</td>
<td>0.015070</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>U28</td>
<td>no</td>
<td>0</td>
<td>strength</td>
<td>&lt; 30</td>
<td>yes</td>
<td>25000</td>
<td>18</td>
<td>0.3</td>
<td>0</td>
<td>...</td>
<td>0.006081</td>
<td>0.005424</td>
<td>0.007153</td>
<td>0.005244</td>
<td>0.008038</td>
<td>endurance</td>
<td>0.008038</td>
<td>0.000929</td>
<td>13.078011</td>
<td>0.004860</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>U59</td>
<td>no</td>
<td>0</td>
<td>strength</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>36</td>
<td>1.2</td>
<td>1</td>
<td>...</td>
<td>0.244028</td>
<td>0.211679</td>
<td>0.291270</td>
<td>0.243492</td>
<td>0.301579</td>
<td>endurance</td>
<td>0.301579</td>
<td>0.011213</td>
<td>47.059571</td>
<td>0.211075</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599989</td>
<td>U3462835</td>
<td>no</td>
<td>0</td>
<td>control</td>
<td>30 to 44</td>
<td>yes</td>
<td>45000</td>
<td>20</td>
<td>0.8</td>
<td>1</td>
<td>...</td>
<td>0.081865</td>
<td>0.060368</td>
<td>0.063264</td>
<td>0.057766</td>
<td>0.070770</td>
<td>team</td>
<td>0.081865</td>
<td>0.004871</td>
<td>32.245840</td>
<td>0.062828</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599992</td>
<td>U3462858</td>
<td>no</td>
<td>0</td>
<td>control</td>
<td>45 to 59</td>
<td>yes</td>
<td>40000</td>
<td>16</td>
<td>1.1</td>
<td>0</td>
<td>...</td>
<td>0.056256</td>
<td>0.041872</td>
<td>0.041478</td>
<td>0.040307</td>
<td>0.037076</td>
<td>team</td>
<td>0.056256</td>
<td>0.003052</td>
<td>38.458959</td>
<td>0.046946</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599993</td>
<td>U3462877</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>&lt; 30</td>
<td>no</td>
<td>65000</td>
<td>30</td>
<td>1.0</td>
<td>2</td>
<td>...</td>
<td>0.176618</td>
<td>0.232750</td>
<td>0.283269</td>
<td>0.223465</td>
<td>0.266163</td>
<td>water</td>
<td>0.283269</td>
<td>0.014259</td>
<td>45.079704</td>
<td>0.257119</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>...</td>
<td>0.030821</td>
<td>0.023935</td>
<td>0.033779</td>
<td>0.028076</td>
<td>0.036240</td>
<td>endurance</td>
<td>0.036240</td>
<td>0.002042</td>
<td>38.698478</td>
<td>0.031609</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>...</td>
<td>0.119600</td>
<td>0.121016</td>
<td>0.170371</td>
<td>0.139849</td>
<td>0.178244</td>
<td>endurance</td>
<td>0.178244</td>
<td>0.008225</td>
<td>32.707711</td>
<td>0.107603</td>
</tr>
</tbody>
</table>

<p>420000 rows × 55 columns</p>
</div>
</div>
</div>
</div>
<div id="345cb367" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>NN <span class="op">=</span> rsm.model.mlp(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    rvar<span class="op">=</span><span class="st">'buyer_yes'</span>,</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    evar<span class="op">=</span> evar,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    hidden_layer_sizes<span class="op">=</span>(<span class="dv">1</span>,),  <span class="co"># Simple NN with 1 hidden layer</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    mod_type<span class="op">=</span><span class="st">'classification'</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>NN.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Multi-layer Perceptron (NN)
Data                 : pentathlon_nptb
Response variable    : buyer_yes
Level                : None
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Model type           : classification
Nr. of features      : (12, 19)
Nr. of observations  : 420,000
Hidden_layer_sizes   : (1,)
Activation function  : tanh
Solver               : lbfgs
Alpha                : 0.0001
Batch size           : auto
Learning rate        : 0.001
Maximum iterations   : 10000
random_state         : 1234
AUC                  : 0.884

Raw data             :
  message      age female  income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet
     team 30 to 44     no   55000         19       0.8               0              4           0          4                 0             1
endurance 45 to 59    yes   45000         33       0.7               0              0           0          0                 2             2
    water 45 to 59    yes   25000         24       0.2               0              0           0          0                 0             0
 strength     &lt; 30    yes   25000         18       0.3               0              0           0          0                 0             0
 strength    &gt;= 60    yes   65000         36       1.2               1              1           0          2                 0             3

Estimation data      :
   income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
 0.388655  -0.663713 -0.265321       -0.640336       1.100861   -0.261727   1.892088         -0.690593      0.058975            False              False            False             False          True          False          True         False      False       True
-0.184052   0.279378 -0.479844       -0.640336      -0.706563   -0.261727  -0.620020          1.958233      0.882489            False               True            False             False         False          False         False          True      False      False
-1.329467  -0.326895 -1.552460       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False             False         False           True         False          True      False      False
-1.329467  -0.731077 -1.337937       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False              True         False          False         False         False      False      False
 0.961362   0.481469  0.592772        0.060592      -0.254707   -0.261727   0.636034         -0.690593      1.706002            False              False            False              True         False          False         False         False       True      False</code></pre>
</div>
</div>
<div id="ba1ca1a7" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>NN100 <span class="op">=</span> rsm.model.mlp(</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    rvar<span class="op">=</span><span class="st">'buyer_yes'</span>,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    evar<span class="op">=</span> evar,</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    hidden_layer_sizes<span class="op">=</span>(<span class="dv">100</span>,),  <span class="co"># more complex NN with 100 hidden layers</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    mod_type<span class="op">=</span><span class="st">'classification'</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>NN100.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Multi-layer Perceptron (NN)
Data                 : pentathlon_nptb
Response variable    : buyer_yes
Level                : None
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Model type           : classification
Nr. of features      : (12, 19)
Nr. of observations  : 420,000
Hidden_layer_sizes   : (100,)
Activation function  : tanh
Solver               : lbfgs
Alpha                : 0.0001
Batch size           : auto
Learning rate        : 0.001
Maximum iterations   : 10000
random_state         : 1234
AUC                  : 0.892

Raw data             :
  message      age female  income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet
     team 30 to 44     no   55000         19       0.8               0              4           0          4                 0             1
endurance 45 to 59    yes   45000         33       0.7               0              0           0          0                 2             2
    water 45 to 59    yes   25000         24       0.2               0              0           0          0                 0             0
 strength     &lt; 30    yes   25000         18       0.3               0              0           0          0                 0             0
 strength    &gt;= 60    yes   65000         36       1.2               1              1           0          2                 0             3

Estimation data      :
   income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
 0.388655  -0.663713 -0.265321       -0.640336       1.100861   -0.261727   1.892088         -0.690593      0.058975            False              False            False             False          True          False          True         False      False       True
-0.184052   0.279378 -0.479844       -0.640336      -0.706563   -0.261727  -0.620020          1.958233      0.882489            False               True            False             False         False          False         False          True      False      False
-1.329467  -0.326895 -1.552460       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False             False         False           True         False          True      False      False
-1.329467  -0.731077 -1.337937       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False              True         False          False         False         False      False      False
 0.961362   0.481469  0.592772        0.060592      -0.254707   -0.261727   0.636034         -0.690593      1.706002            False              False            False              True         False          False         False         False       True      False</code></pre>
</div>
</div>
<section id="model-tuning" class="level4">
<h4 class="anchored" data-anchor-id="model-tuning">Model Tuning</h4>
<div id="5953128a" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NN_cv = rsm.load_state("./data/NN_cv.pkl")['NN_cv']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After fine-tuning the model in a separate notebook, we preserved the model’s state with save_state. To reintegrate it into the main notebook, load_state was utilized. However, due to GitHub’s file evaluation constraints, we are unable to successfully pass the automated tests using the aforementioned code. Should you wish to review our tuned model, please refer to the auxiliary notebooks. You can replicate our steps there by employing the provided code above</p>
<div id="5994a8af" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NN_cv.best_params_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="12061c56" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NN_cv.best_score_.round(3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9a808368" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>NN_best <span class="op">=</span> rsm.model.mlp(</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    rvar<span class="op">=</span><span class="st">'buyer_yes'</span>,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    evar<span class="op">=</span> evar,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    hidden_layer_sizes <span class="op">=</span> (<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    mod_type<span class="op">=</span><span class="st">'classification'</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>NN_best.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Multi-layer Perceptron (NN)
Data                 : pentathlon_nptb
Response variable    : buyer_yes
Level                : None
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Model type           : classification
Nr. of features      : (12, 19)
Nr. of observations  : 420,000
Hidden_layer_sizes   : (3, 3)
Activation function  : tanh
Solver               : lbfgs
Alpha                : 0.01
Batch size           : auto
Learning rate        : 0.001
Maximum iterations   : 10000
random_state         : 1234
AUC                  : 0.89

Raw data             :
  message      age female  income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet
     team 30 to 44     no   55000         19       0.8               0              4           0          4                 0             1
endurance 45 to 59    yes   45000         33       0.7               0              0           0          0                 2             2
    water 45 to 59    yes   25000         24       0.2               0              0           0          0                 0             0
 strength     &lt; 30    yes   25000         18       0.3               0              0           0          0                 0             0
 strength    &gt;= 60    yes   65000         36       1.2               1              1           0          2                 0             3

Estimation data      :
   income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
 0.388655  -0.663713 -0.265321       -0.640336       1.100861   -0.261727   1.892088         -0.690593      0.058975            False              False            False             False          True          False          True         False      False       True
-0.184052   0.279378 -0.479844       -0.640336      -0.706563   -0.261727  -0.620020          1.958233      0.882489            False               True            False             False         False          False         False          True      False      False
-1.329467  -0.326895 -1.552460       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False             False         False           True         False          True      False      False
-1.329467  -0.731077 -1.337937       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False              True         False          False         False         False      False      False
 0.961362   0.481469  0.592772        0.060592      -0.254707   -0.261727   0.636034         -0.690593      1.706002            False              False            False              True         False          False         False         False       True      False</code></pre>
</div>
</div>
<div id="a17ef13e" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pred_NN'</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb)[<span class="st">'prediction'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="307824cb" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>dct <span class="op">=</span> {<span class="st">"train"</span> : pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"test"</span> : pentathlon_nptb.query(<span class="st">"training == 0"</span>)}</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> rsm.gains_plot(dct, <span class="st">"buyer"</span>, <span class="st">"yes"</span>, <span class="st">"pred_NN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-73-output-1.png" width="610" height="435" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="d22bb086" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on training set</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">'pred_NN'</span>]</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">'buyer_yes'</span>]</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual, pred)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>0.89011</code></pre>
</div>
</div>
<div id="457a6c83" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on test set</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">'pred_NN'</span>]</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">'buyer_yes'</span>]</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual, pred)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>0.88819</code></pre>
</div>
</div>
<p>We can conclude that:</p>
<p>The AUC for the training set is 0.890, which indicates that the model has a very good ability to distinguish between the two classes in the training data.</p>
<p>The AUC for the test set is 0.888, which is nearly the same as the training AUC. This means that the model is generalizing well to new data and not overfitting to the training data. The small decrease from training to test is nearly negligible.</p>
</section>
<section id="create-predictions" class="level3">
<h3 class="anchored" data-anchor-id="create-predictions">1. Create predictions</h3>
<div id="ead3432f" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for all unique message values in the dataset and count how many</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>message
control        87260
racquet        87088
team           86792
backcountry    86604
water          85120
strength       84280
endurance      82856
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="53a8fa58" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions for different scenarios where the message variable is set to specific values</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_control_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_racquet_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_team_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_backcountry_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_water_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_strength_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_endurance_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">ordersize_random_reg</th>
<th data-quarto-table-cell-role="th">ep_random_lr</th>
<th data-quarto-table-cell-role="th">pred_NN</th>
<th data-quarto-table-cell-role="th">p_control_nn</th>
<th data-quarto-table-cell-role="th">p_racquet_nn</th>
<th data-quarto-table-cell-role="th">p_team_nn</th>
<th data-quarto-table-cell-role="th">p_backcountry_nn</th>
<th data-quarto-table-cell-role="th">p_water_nn</th>
<th data-quarto-table-cell-role="th">p_strength_nn</th>
<th data-quarto-table-cell-role="th">p_endurance_nn</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>...</td>
<td>32.627819</td>
<td>0.156712</td>
<td>0.011532</td>
<td>0.009833</td>
<td>0.011503</td>
<td>0.011532</td>
<td>0.011059</td>
<td>0.010634</td>
<td>0.011800</td>
<td>0.011186</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>U3</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>45 to 59</td>
<td>no</td>
<td>35000</td>
<td>22</td>
<td>1.0</td>
<td>0</td>
<td>...</td>
<td>37.181377</td>
<td>0.082633</td>
<td>0.002658</td>
<td>0.002535</td>
<td>0.002404</td>
<td>0.003184</td>
<td>0.002658</td>
<td>0.003101</td>
<td>0.003468</td>
<td>0.002342</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>...</td>
<td>40.744326</td>
<td>0.226274</td>
<td>0.008840</td>
<td>0.006773</td>
<td>0.007218</td>
<td>0.008068</td>
<td>0.007635</td>
<td>0.008054</td>
<td>0.009127</td>
<td>0.008840</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>...</td>
<td>15.768889</td>
<td>0.015070</td>
<td>0.001161</td>
<td>0.001065</td>
<td>0.001360</td>
<td>0.000875</td>
<td>0.001357</td>
<td>0.001161</td>
<td>0.001291</td>
<td>0.003342</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>U25</td>
<td>no</td>
<td>0</td>
<td>racquet</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>32</td>
<td>1.1</td>
<td>1</td>
<td>...</td>
<td>48.946607</td>
<td>0.235699</td>
<td>0.009574</td>
<td>0.007788</td>
<td>0.009574</td>
<td>0.008922</td>
<td>0.008792</td>
<td>0.008076</td>
<td>0.008884</td>
<td>0.008817</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>...</td>
<td>38.698478</td>
<td>0.031609</td>
<td>0.001644</td>
<td>0.001504</td>
<td>0.001932</td>
<td>0.001207</td>
<td>0.001928</td>
<td>0.001644</td>
<td>0.001835</td>
<td>0.004317</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599996</td>
<td>U3462900</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>3</td>
<td>...</td>
<td>29.767369</td>
<td>0.091593</td>
<td>0.004586</td>
<td>0.003494</td>
<td>0.003388</td>
<td>0.004586</td>
<td>0.003605</td>
<td>0.004077</td>
<td>0.004503</td>
<td>0.002707</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>...</td>
<td>32.707711</td>
<td>0.107603</td>
<td>0.002481</td>
<td>0.001935</td>
<td>0.002163</td>
<td>0.002481</td>
<td>0.001966</td>
<td>0.001951</td>
<td>0.002062</td>
<td>0.001856</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599998</td>
<td>U3462916</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>50000</td>
<td>35</td>
<td>0.6</td>
<td>2</td>
<td>...</td>
<td>25.117259</td>
<td>0.068280</td>
<td>0.003051</td>
<td>0.002224</td>
<td>0.002025</td>
<td>0.003051</td>
<td>0.002200</td>
<td>0.002624</td>
<td>0.002867</td>
<td>0.001594</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599999</td>
<td>U3462922</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>30 to 44</td>
<td>yes</td>
<td>50000</td>
<td>25</td>
<td>0.7</td>
<td>1</td>
<td>...</td>
<td>29.102240</td>
<td>0.138029</td>
<td>0.002656</td>
<td>0.003538</td>
<td>0.003329</td>
<td>0.004762</td>
<td>0.003617</td>
<td>0.004233</td>
<td>0.004701</td>
<td>0.002656</td>
</tr>
</tbody>
</table>

<p>600000 rows × 63 columns</p>
</div>
</div>
</div>
</div>
<div id="3aab71c7" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_nn"</span>: <span class="st">"control"</span>, </span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_nn"</span>: <span class="st">"endurance"</span>, </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_nn"</span>: <span class="st">"backcountry"</span>, </span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_nn"</span>: <span class="st">"racquet"</span>, </span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_nn"</span>: <span class="st">"strength"</span>, </span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_nn"</span>: <span class="st">"team"</span>, </span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_nn"</span>: <span class="st">"water"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a4f4d3f9" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extending the prediction to the full database to see distribution</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>predictions_nn <span class="op">=</span> [</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_nn"</span>, </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_nn"</span>, </span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_nn"</span>, </span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_nn"</span>, </span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_nn"</span>, </span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_nn"</span>, </span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_nn"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="15f29937" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extending the prediction to the full database to see distribution</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message_nn"</span>] <span class="op">=</span> pentathlon_nptb[predictions_nn].idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message_nn"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<pre><code>message_nn
p_endurance_nn    321011
p_strength_nn     161291
p_team_nn         106081
p_racquet_nn       11617
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="4c0fb719" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the maximum probability of purchase</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_max_nn"</span>] <span class="op">=</span> pentathlon_nptb[predictions_nn].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Approach: First of all, a neural network model was built to predict the next product to buy using buyer_yes as the response variable and the other variables as predictors. The model was trained using the training data and then used to predict the probability of purchasing for the test data. The model was then used to predict the probability of purchasing for the full database. To predict the probability of purchasing for different messages, we use the <code>data_cmd</code> to predict the probability of purchasing for different messages.</p>
<p>Finally, we choose the product with the highest probability using <code>idxmax</code> to automatically find the best message for each customer. This command also provides a label for the category with the maximum predicted probability of buying across all the products. Then, <code>p_max</code> was created to store the maximum predicted probability of purchasing for the best message selected for each customer.</p>
<section id="percentage-of-customersfor-whom-that-message-or-not-message" class="level4">
<h4 class="anchored" data-anchor-id="percentage-of-customersfor-whom-that-message-or-not-message">2. Percentage of customersfor whom that message or not message</h4>
<div id="37b2d3c1" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a crosstab to see which products should we send to each customer.</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].message_nn, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">message_nn</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">p_endurance_nn</td>
<td>96,065</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">p_racquet_nn</td>
<td>3,473</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">p_strength_nn</td>
<td>48,593</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">p_team_nn</td>
<td>31,869</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="3b6dd40f" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># percentage of customers for whom that message is the best message</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"message_nn"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>message_nn
p_endurance_nn    0.535018
p_strength_nn     0.268818
p_team_nn         0.176802
p_racquet_nn      0.019362
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<ul>
<li><p><code>edurance</code>: The distribution suggests that <code>endurance</code>, related messages resonate significantly more with the customers than the other messages.</p></li>
<li><p><code>team</code>: While not as dominant as <code>endurance</code>, related messages also play an important role. There might be opportunities to further optimize or tailor these messages to increase their effectiveness.</p></li>
<li><p>Other categories such as <code>strength</code>, <code>racquet</code>, and <code>water</code>, have much smaller proportions, suggesting that they are less often the best choice for maximizing the probability of purchase.</p></li>
<li><p><code>backcountry</code> was not included in the original dataset, so it is not surprising that it is not the best message for any customer.`</p></li>
</ul>
<div id="e7a05b06" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># average purchase probability if we send the message for each product to everyone</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, predictions_nn].agg(<span class="st">"mean"</span>).sort_values(</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(rsm.format_nr, perc<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>p_endurance_nn      2.75%
p_strength_nn       2.64%
p_water_nn          2.42%
p_team_nn           2.37%
p_backcountry_nn    2.33%
p_racquet_nn        2.29%
p_control_nn        2.14%
dtype: object</code></pre>
</div>
</div>
</section>
<section id="expected-profit-1" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit-1">3. Expected profit</h4>
<div id="651f1d82" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the avg order size/message</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>ordersize <span class="op">=</span> pentathlon_nptb[(pentathlon_nptb.training <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pentathlon_nptb.buyer_yes <span class="op">==</span> <span class="dv">1</span>)].groupby(<span class="st">"message"</span>)[<span class="st">"total_os"</span>].mean()</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>ordersize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/3828228129.py:2: FutureWarning:

The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>message
backcountry    64.034091
control        49.900598
endurance      55.584893
racquet        56.405620
strength       56.708751
team           56.522449
water          61.957343
Name: total_os, dtype: float64</code></pre>
</div>
</div>
<div id="d565337f" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>NN_os <span class="op">=</span> rsm.model.mlp(</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    rvar <span class="op">=</span> <span class="st">"total_os"</span>,</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    evar <span class="op">=</span> evar,</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>    hidden_layer_sizes <span class="op">=</span> (<span class="dv">1</span>,),  <span class="co"># Simple NN with 1 hidden layer</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    mod_type <span class="op">=</span> <span class="st">'regression'</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>NN_os.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Multi-layer Perceptron (NN)
Data                 : pentathlon_nptb
Response variable    : total_os
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Model type           : regression
Nr. of features      : (12, 19)
Nr. of observations  : 420,000
Hidden_layer_sizes   : (1,)
Activation function  : tanh
Solver               : lbfgs
Alpha                : 0.0001
Batch size           : auto
Learning rate        : 0.001
Maximum iterations   : 10000
random_state         : 1234
Model fit            :
       n     r2    mse    mae
  420000  0.109  0.891  0.179

Raw data             :
  message      age female  income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet
     team 30 to 44     no   55000         19       0.8               0              4           0          4                 0             1
endurance 45 to 59    yes   45000         33       0.7               0              0           0          0                 2             2
    water 45 to 59    yes   25000         24       0.2               0              0           0          0                 0             0
 strength     &lt; 30    yes   25000         18       0.3               0              0           0          0                 0             0
 strength    &gt;= 60    yes   65000         36       1.2               1              1           0          2                 0             3

Estimation data      :
   income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
 0.388655  -0.663713 -0.265321       -0.640336       1.100861   -0.261727   1.892088         -0.690593      0.058975            False              False            False             False          True          False          True         False      False       True
-0.184052   0.279378 -0.479844       -0.640336      -0.706563   -0.261727  -0.620020          1.958233      0.882489            False               True            False             False         False          False         False          True      False      False
-1.329467  -0.326895 -1.552460       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False             False         False           True         False          True      False      False
-1.329467  -0.731077 -1.337937       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False              True         False          False         False         False      False      False
 0.961362   0.481469  0.592772        0.060592      -0.254707   -0.261727   0.636034         -0.690593      1.706002            False              False            False              True         False          False         False         False       True      False</code></pre>
</div>
</div>
</section>
<section id="model-tuning-1" class="level4">
<h4 class="anchored" data-anchor-id="model-tuning-1">Model Tuning</h4>
<div id="e61ff6fe" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NN_os = rsm.load_state("./data/NN_os.pkl")['NN_os']</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, after fine-tuning the model in a separate notebook, we preserved the model’s state with save_state. To reintegrate it into the main notebook, load_state was utilized. However, due to GitHub’s file evaluation constraints, we are unable to successfully pass the automated tests using the aforementioned code. Should you wish to review our tuned model, please refer to the auxiliary notebooks. You can replicate our steps there by employing the provided code above</p>
<div id="3f005dd9" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NN_os.best_params_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1bc9b479" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NN_cv.best_score_.round(3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="037c1506" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>NN_os_best <span class="op">=</span> rsm.model.mlp(</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>{<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[pentathlon_nptb[<span class="st">"training"</span>] <span class="op">==</span> <span class="dv">1</span>]},</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    rvar<span class="op">=</span><span class="st">"total_os"</span>,</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    evar<span class="op">=</span> evar,</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> <span class="fl">0.0001</span>,</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    hidden_layer_sizes <span class="op">=</span> (<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>    mod_type<span class="op">=</span><span class="st">'regression'</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>NN_os_best.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Multi-layer Perceptron (NN)
Data                 : pentathlon_nptb
Response variable    : total_os
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
Model type           : regression
Nr. of features      : (12, 19)
Nr. of observations  : 420,000
Hidden_layer_sizes   : (3, 3)
Activation function  : tanh
Solver               : lbfgs
Alpha                : 0.0001
Batch size           : auto
Learning rate        : 0.001
Maximum iterations   : 10000
random_state         : 1234
Model fit            :
       n     r2    mse    mae
  420000  0.114  0.886  0.175

Raw data             :
  message      age female  income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet
     team 30 to 44     no   55000         19       0.8               0              4           0          4                 0             1
endurance 45 to 59    yes   45000         33       0.7               0              0           0          0                 2             2
    water 45 to 59    yes   25000         24       0.2               0              0           0          0                 0             0
 strength     &lt; 30    yes   25000         18       0.3               0              0           0          0                 0             0
 strength    &gt;= 60    yes   65000         36       1.2               1              1           0          2                 0             3

Estimation data      :
   income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
 0.388655  -0.663713 -0.265321       -0.640336       1.100861   -0.261727   1.892088         -0.690593      0.058975            False              False            False             False          True          False          True         False      False       True
-0.184052   0.279378 -0.479844       -0.640336      -0.706563   -0.261727  -0.620020          1.958233      0.882489            False               True            False             False         False          False         False          True      False      False
-1.329467  -0.326895 -1.552460       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False             False         False           True         False          True      False      False
-1.329467  -0.731077 -1.337937       -0.640336      -0.706563   -0.261727  -0.620020         -0.690593     -0.764538            False              False            False              True         False          False         False         False      False      False
 0.961362   0.481469  0.592772        0.060592      -0.254707   -0.261727   0.636034         -0.690593      1.706002            False              False            False              True         False          False         False         False       True      False</code></pre>
</div>
</div>
<div id="30da92cd" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_control_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_racquet_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_team_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_backcountry_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_water_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_strength_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"pos_endurance_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="85cc6226" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_control_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_control_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_control_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_racquet_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_racquet_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_racquet_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_team_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_team_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_team_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_backcountry_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_backcountry_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_backcountry_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_water_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_water_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_water_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_strength_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_strength_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_strength_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_endurance_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_endurance_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"pos_endurance_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f9a573b9" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>expected_profit_nn <span class="op">=</span> [</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_control_nn"</span>, </span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_endurance_nn"</span>, </span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_backcountry_nn"</span>, </span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_racquet_nn"</span>, </span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_strength_nn"</span>, </span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_team_nn"</span>, </span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_water_nn"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="244154f9" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {<span class="st">"ep_control_nn"</span>: <span class="st">"control"</span>, <span class="st">"ep_endurance_nn"</span>: <span class="st">"endurance"</span>, <span class="st">"ep_backcountry_nn"</span>: <span class="st">"backcountry"</span>, <span class="st">"ep_racquet_nn"</span>: <span class="st">"racquet"</span>, <span class="st">"ep_strength_nn"</span>: <span class="st">"strength"</span>, <span class="st">"ep_team_nn"</span>: <span class="st">"team"</span>, <span class="st">"ep_water_nn"</span>: <span class="st">"water"</span>}</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_message_nn"</span>] <span class="op">=</span> (</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[expected_profit_nn]</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="respective-message-maximizes-expected-profit" class="level3">
<h3 class="anchored" data-anchor-id="respective-message-maximizes-expected-profit">4. Respective message maximizes expected profit</h3>
<div id="094b4ee2" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.ep_message_nn.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>ep_message_nn
endurance      0.369478
team           0.245130
water          0.221107
strength       0.110613
backcountry    0.024117
racquet        0.019118
control        0.010437
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<p>The message that most customers respond the best to is <code>endurance</code> holding close to almost half of the customer. Messages such as <code>backcountry</code>, <code>racquet</code>, and <code>control</code> are not the best choice for nearly any customer. The remaining three messages, <code>team</code>, <code>strength</code>, and <code>water</code>, are the best choice for a small proportion of customers.</p>
</section>
<section id="expected-profitcustomer" class="level3">
<h3 class="anchored" data-anchor-id="expected-profitcustomer">5. Expected profit/customer</h3>
<div id="334d27ee" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max_nn"</span>] <span class="op">=</span> pentathlon_nptb[expected_profit_nn].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max_nn"</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>0.6816084703184525</code></pre>
</div>
</div>
<div id="6afdefef" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].ep_message_nn, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ep_message_nn</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>4,371</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">control</td>
<td>1,914</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">endurance</td>
<td>66,071</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">racquet</td>
<td>3,429</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">strength</td>
<td>19,986</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">team</td>
<td>44,334</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">water</td>
<td>39,895</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<section id="expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message-1" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message-1">6. Expected profit per e-mailed customer if every customer receives the same message</h4>
<div id="83a0d51e" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    .loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, expected_profit_nn]</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    .agg(<span class="st">"mean"</span>)</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(rsm.format_nr, sym <span class="op">=</span> <span class="st">"$"</span>, dec <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>ep_endurance_nn      $0.61
ep_strength_nn        $0.6
ep_water_nn           $0.6
ep_backcountry_nn    $0.59
ep_team_nn           $0.53
ep_racquet_nn        $0.52
ep_control_nn        $0.43
dtype: object</code></pre>
</div>
</div>
<p>To no surprise, sending no message yields the lowest expected profit per customer. The message that maximizes the expected profit per customer are <code>endurance</code> and <code>strength</code> tied. The remaining messages of <code>team</code>, <code>water</code>, <code>backcountry</code> yield slightly less than <code>strength</code> and <code>endurance</code>. <code>Racquet</code> yields slightly more than sending no message but still less than the other messages.</p>
</section>
</section>
<section id="expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-options" class="level3">
<h3 class="anchored" data-anchor-id="expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-options">7. Expected profit per e-mailed customer if every customer is assigned randomly to one of the messages options</h3>
<div id="f2be61a8" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probabilty of purchase where customer is assigned to a random message</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_random_nn"</span>] <span class="op">=</span> NN_best.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected avg order size where customer is assigned to a random message</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ordersize_random_nn"</span>] <span class="op">=</span> NN_os_best.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit where customer is assigned to a random message</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_random_nn"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_random_nn"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"ordersize_random_nn"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit per customer where customer is assigned to a random message</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>random_profit_per_customer <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_random_nn"</span>].mean()</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>random_profit_per_customer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>0.1078448520217575</code></pre>
</div>
</div>
<div id="fc8f91a2" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit where no-message is sent (control)</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_control_nn"</span>]</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit per customer where no-message is sent (control)</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_control_nn"</span>].mean()</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>0.4335109104691227</code></pre>
</div>
</div>
</section>
<section id="expected-profit-for-5000000-customers" class="level3">
<h3 class="anchored" data-anchor-id="expected-profit-for-5000000-customers">8. Expected profit for 5,000,000 customers</h3>
<div id="1affa706" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where each customer is assigned to the message with the highest expected profit</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>profit_nn <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_max_nn"</span>].agg(<span class="st">"mean"</span>) <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>profit_nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>3430076.6444671643</code></pre>
</div>
</div>
<div id="66246cd9" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where each customer is sent to a random message</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>random_profit_nn <span class="op">=</span> random_profit_per_customer <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>random_profit_nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>539224.2601087876</code></pre>
</div>
</div>
<div id="50d94e39" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where no message is sent</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>control_profit_nn <span class="op">=</span> control_profit_per_customer <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>control_profit_nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="102">
<pre><code>2167554.5523456135</code></pre>
</div>
</div>
<div id="090f0419" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>profit_improvement_nn <span class="op">=</span> profit_nn <span class="op">-</span> control_profit_nn</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>profit_improvement_nn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre><code>1262522.0921215508</code></pre>
</div>
</div>
<div id="a2133d6d" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>profits_dct <span class="op">=</span> {</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Customize Message"</span>: profit_nn,</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Randomly Assign"</span>: random_profit_nn,</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Message Sent"</span>: control_profit_nn,</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dictionary to DataFrame</span></span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(profits_dct.items()), columns<span class="op">=</span>[<span class="st">'Model'</span>, <span class="st">'Profit'</span>])</span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))  </span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"Model"</span>, y<span class="op">=</span><span class="st">"Profit"</span>, data<span class="op">=</span>df, palette<span class="op">=</span><span class="st">"viridis"</span>)</span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotations</span></span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>    ax.text(index, row.Profit, <span class="ss">f'$</span><span class="sc">{</span>row<span class="sc">.</span>Profit<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Model Type"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Profit"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Profit by Model"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">15</span>})</span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>) </span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/3855792413.py:16: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-105-output-2.png" width="817" height="549" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="random-forest-model" class="level2">
<h2 class="anchored" data-anchor-id="random-forest-model">Random Forest Model</h2>
<section id="train-a-random-forest-model-to-predict-the-next-product-to-buy" class="level3">
<h3 class="anchored" data-anchor-id="train-a-random-forest-model-to-predict-the-next-product-to-buy">Train a Random Forest Model to predict the next product to buy</h3>
<div id="7f8b3f86" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> rsm.model.rforest(</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {<span class="st">'NPTB'</span>: pentathlon_nptb.query(<span class="st">"training == 1"</span>)},</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    rvar <span class="op">=</span> <span class="st">'buyer'</span>,</span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>    lev <span class="op">=</span> <span class="st">'yes'</span>,</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>    evar <span class="op">=</span> evar,</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>rf.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest
Data                 : NPTB
Response variable    : buyer
Level                : yes
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
OOB                  : True
Model type           : classification
Nr. of features      : (12, 21)
Nr. of observations  : 420,000
max_features         : sqrt (4)
n_estimators         : 100
min_samples_leaf     : 1
random_state         : 1234
AUC                  : 0.825

Estimation data      :
 income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_backcountry  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_&lt; 30  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
  55000         19       0.8               0              4           0          4                 0             1                False            False              False            False             False          True          False     False          True         False      False       True
  45000         33       0.7               0              0           0          0                 2             2                False            False               True            False             False         False          False     False         False          True      False      False
  25000         24       0.2               0              0           0          0                 0             0                False            False              False            False             False         False           True     False         False          True      False      False
  25000         18       0.3               0              0           0          0                 0             0                False            False              False            False              True         False          False      True         False         False      False      False
  65000         36       1.2               1              1           0          2                 0             3                False            False              False            False              True         False          False     False         False         False       True      False</code></pre>
</div>
</div>
<p>We want to also use a random forest model to predict the next product to buy and see if we can create a robust NPTB model that accurately can predict which product a customer would purchase based on the messaging we send them. Above, we are training our base random forest model, and we will use this base random forest model to tune our hyperparameters, as seen below.</p>
<p>Some interesting key features of the output of this random forest model is the AUC value. In our base model, we see that the AUC is a 0.818. This is a decent value for AUC, with anything over 0.5 typically being considered a good model.</p>
<section id="random-forest-model-tuning" class="level4">
<h4 class="anchored" data-anchor-id="random-forest-model-tuning">Random Forest Model Tuning</h4>
<div id="a2850caa" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co">#max_features = [None, 'auto', 'sqrt', 'log2', 0.25, 0.5, 0.75, 1.0]</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="co">#n_estimators = [10, 50, 100, 200, 500, 1000]</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="co">#param_grid = {"max_features": max_features, "n_estimators": n_estimators}</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="co">#scoring = {"AUC": "roc_auc"}</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a><span class="co">#rf_cv = GridSearchCV(rf.fitted, param_grid, scoring=scoring, cv=5, n_jobs=2, refit="AUC", verbose=5)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is the code for the grid search of a very large matrix. I would not recommend running this, as it takes a very long time to run. However, I have included the code for the grid search below.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>rf_cv.fit(rf.data_onehot, rf.data.buyer_yes)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>::: {<span class="co">#bdc7b1cb .cell execution_count=107}</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>``` {.python .cell<span class="op">-</span>code}</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="co">#rf_cv.fit(rf_treatment.data_onehot, rf_treatment.data.buyer_yes)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
<p>Above, we conduct a grid search to identify which hyperparameters are best for our random forest model. However, when running a gridsearch this large, we ran into a computational cost issue that caused either our hyperparameter grid search to run for 4 hours, or caused the kernel to crash. Therefore, we conducted multiple step-wise grid searches where we limited the gridsearch matrix size, and went through the various iterations of combinations to see which parameters created the most robut model. Below, you can see the various rounds of model tuning.</p>
</section>
<section id="random-forest-model-tuning---stepwise-limiting-the-grid-search" class="level4">
<h4 class="anchored" data-anchor-id="random-forest-model-tuning---stepwise-limiting-the-grid-search">Random Forest Model Tuning - Stepwise, limiting the grid search</h4>
<div id="0e47734d" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co">#max_features1 = ['sqrt']</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="co">#n_estimators1 = [1000, 2000]</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="co">#param_grid = {"max_features": max_features1, "n_estimators": n_estimators1}</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="co">#scoring = {"AUC": "roc_auc"}</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a><span class="co">#rf_cv_treatment1 = GridSearchCV(rf_treatment.fitted, param_grid, scoring=scoring, cv=4, n_jobs=2, refit="AUC", verbose=5)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because our random forest model took over 4 hours to run previously, we decided to limit the grid search to 9 iterations. Our goal is to create a balance between exploring the hyperparameter space and keeping the computational cost reasonable.</p>
<div id="9b972de0" class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rf_cv_treatment1.fit(rf_treatment.data_onehot, rf_treatment.data.buyer_yes)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3c0a3a26" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rf_cv_treatment1.best_params_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As seen above, the grid search identified that the best parameters were as follows: - max_features: ‘sqrt’ - n_estimators: 1000</p>
<p>When we run our random forest model with the best parameters identified from the grid search, the AUC score is approximately 0.862.</p>
<div id="a8fb1bf7" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>rf_tuned <span class="op">=</span> rsm.model.rforest(</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {<span class="st">'NPTB'</span>: pentathlon_nptb.query(<span class="st">"training == 1"</span>)},</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    rvar <span class="op">=</span> <span class="st">'buyer'</span>,</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    lev <span class="op">=</span> <span class="st">'yes'</span>,</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    evar <span class="op">=</span> evar,</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>    n_estimators <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>    max_features <span class="op">=</span> <span class="st">'sqrt'</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>rf_tuned.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest
Data                 : NPTB
Response variable    : buyer
Level                : yes
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
OOB                  : True
Model type           : classification
Nr. of features      : (12, 21)
Nr. of observations  : 420,000
max_features         : sqrt (4)
n_estimators         : 1000
min_samples_leaf     : 1
random_state         : 1234
AUC                  : 0.864

Estimation data      :
 income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_backcountry  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_&lt; 30  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
  55000         19       0.8               0              4           0          4                 0             1                False            False              False            False             False          True          False     False          True         False      False       True
  45000         33       0.7               0              0           0          0                 2             2                False            False               True            False             False         False          False     False         False          True      False      False
  25000         24       0.2               0              0           0          0                 0             0                False            False              False            False             False         False           True     False         False          True      False      False
  25000         18       0.3               0              0           0          0                 0             0                False            False              False            False              True         False          False      True         False         False      False      False
  65000         36       1.2               1              1           0          2                 0             3                False            False              False            False              True         False          False     False         False         False       True      False</code></pre>
</div>
</div>
<div id="ef1573b1" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pred_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb)[<span class="st">'prediction'</span>]</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pred_rf'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>0.025235874483417724</code></pre>
</div>
</div>
<div id="244c7c0a" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>dct_rf <span class="op">=</span> {<span class="st">"train_rf"</span>: pentathlon_nptb.query(<span class="st">"training == 1"</span>), <span class="st">"test_rf"</span>: pentathlon_nptb.query(<span class="st">"training == 0"</span>)}</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> rsm.gains_plot(dct_rf, <span class="st">"buyer"</span>, <span class="st">"yes"</span>, <span class="st">"pred_rf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-114-output-1.png" width="610" height="435" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The gains chart above is a visual representation of the AUC score. The gains chart shows the percentage of the total number of cases in a given category that are captured by the model. Based on the steep rise at the beginning of the curve, indicates that the model is effective at ranking the positive events, i.e.. buyers, higher than the negative ones. The more steep the initial part of the curve, the better the model is at identifying the positive events early on when you start targeting the population based on the model’s scores.</p>
<p>In this specific chart, the model seems to perform fairly well, particularly because the initial sections of both curves are quite steep, indicating that a significant percentage of the positive events can be captured by targeting a relatively small percentage of the population.</p>
<div id="75fe509a" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="067cb09f" class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_rand_message(data, pred_col, message_col):</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">1234</span>)</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">"random_number"</span>] <span class="op">=</span> np.random.randint(<span class="dv">2</span>, size <span class="op">=</span> <span class="bu">len</span>(data))</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">"random_message"</span>] <span class="op">=</span> rsm.ifelse(data[<span class="st">"random_number"</span>] <span class="op">==</span> <span class="dv">1</span>, data[message_col], <span class="st">"no message"</span>)</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">"random_pred"</span>] <span class="op">=</span> rsm.ifelse(data[<span class="st">"random_number"</span>] <span class="op">==</span> <span class="dv">1</span>, data[pred_col], <span class="dv">0</span>)</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0810749a" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on training data</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>pred_rf <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">"pred_rf"</span>]</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>actual_rf <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 1"</span>)[<span class="st">"buyer_yes"</span>]</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual_rf, pred_rf)</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>1.0</code></pre>
</div>
</div>
<div id="d9dc4f88" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prediction on test data</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>pred_rf <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">"pred_rf"</span>]</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>actual_rf <span class="op">=</span> pentathlon_nptb.query(<span class="st">"training == 0"</span>)[<span class="st">"buyer_yes"</span>]</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> metrics.roc_curve(actual_rf, pred_rf)</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>metrics.auc(fpr, tpr).<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre><code>0.869</code></pre>
</div>
</div>
<p>Based on the Gains Chart, and the AUC values for the test and training set, we can conclude that the model is performing decently well. Because of the perfect AUC score on the training data, there is a slight hesitation that the model may be overfitting. However, the AUC score on the test data is still quite high, indicating that the model is generalizing well.</p>
<p>The AUC for the training set is 1, which indicates that the model has a very good ability to distinguish between the two classes in the training data. This is also supported by the steep increase in the first part of the gains chart in the training data. The AUC for the test set is 0.865, which is slightly lower but still indicates a very good predictive performance on unseen data.</p>
</section>
<section id="create-prediction-for-each-product" class="level4">
<h4 class="anchored" data-anchor-id="create-prediction-for-each-product">1. Create prediction for each product</h4>
<div id="810df94d" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_control_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_racquet_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_team_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_backcountry_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_water_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_strength_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_endurance_rf'</span>] <span class="op">=</span> rf_tuned.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="01af9ae0" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">custid</th>
<th data-quarto-table-cell-role="th">buyer</th>
<th data-quarto-table-cell-role="th">total_os</th>
<th data-quarto-table-cell-role="th">message</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">female</th>
<th data-quarto-table-cell-role="th">income</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">children</th>
<th data-quarto-table-cell-role="th">freq_endurance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">ordersize_random_nn</th>
<th data-quarto-table-cell-role="th">ep_random_nn</th>
<th data-quarto-table-cell-role="th">pred_rf</th>
<th data-quarto-table-cell-role="th">p_control_rf</th>
<th data-quarto-table-cell-role="th">p_racquet_rf</th>
<th data-quarto-table-cell-role="th">p_team_rf</th>
<th data-quarto-table-cell-role="th">p_backcountry_rf</th>
<th data-quarto-table-cell-role="th">p_water_rf</th>
<th data-quarto-table-cell-role="th">p_strength_rf</th>
<th data-quarto-table-cell-role="th">p_endurance_rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>U1</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>30 to 44</td>
<td>no</td>
<td>55000</td>
<td>19</td>
<td>0.8</td>
<td>0</td>
<td>...</td>
<td>0.404840</td>
<td>0.001868</td>
<td>0.001000</td>
<td>0.004</td>
<td>0.001</td>
<td>0.001</td>
<td>0.008000</td>
<td>0.012</td>
<td>0.028</td>
<td>0.070000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>U3</td>
<td>no</td>
<td>0</td>
<td>backcountry</td>
<td>45 to 59</td>
<td>no</td>
<td>35000</td>
<td>22</td>
<td>1.0</td>
<td>0</td>
<td>...</td>
<td>0.162739</td>
<td>0.000173</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>U13</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>45 to 59</td>
<td>yes</td>
<td>45000</td>
<td>33</td>
<td>0.7</td>
<td>0</td>
<td>...</td>
<td>0.604567</td>
<td>0.002138</td>
<td>0.001000</td>
<td>0.002</td>
<td>0.000</td>
<td>0.002</td>
<td>0.001333</td>
<td>0.000</td>
<td>0.000</td>
<td>0.001000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>U20</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>45 to 59</td>
<td>yes</td>
<td>25000</td>
<td>24</td>
<td>0.2</td>
<td>0</td>
<td>...</td>
<td>-0.002303</td>
<td>-0.000001</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>U25</td>
<td>no</td>
<td>0</td>
<td>racquet</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>65000</td>
<td>32</td>
<td>1.1</td>
<td>1</td>
<td>...</td>
<td>0.780294</td>
<td>0.002988</td>
<td>0.019000</td>
<td>0.009</td>
<td>0.019</td>
<td>0.007</td>
<td>0.023000</td>
<td>0.009</td>
<td>0.010</td>
<td>0.005000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599995</td>
<td>U3462888</td>
<td>no</td>
<td>0</td>
<td>water</td>
<td>&gt;= 60</td>
<td>yes</td>
<td>40000</td>
<td>26</td>
<td>0.6</td>
<td>0</td>
<td>...</td>
<td>-0.482575</td>
<td>-0.000317</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599996</td>
<td>U3462900</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>3</td>
<td>...</td>
<td>0.155320</td>
<td>0.000285</td>
<td>0.000000</td>
<td>0.001</td>
<td>0.001</td>
<td>0.000</td>
<td>0.000000</td>
<td>0.000</td>
<td>0.001</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599997</td>
<td>U3462902</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>yes</td>
<td>55000</td>
<td>32</td>
<td>0.9</td>
<td>0</td>
<td>...</td>
<td>0.153595</td>
<td>0.000152</td>
<td>0.000000</td>
<td>0.006</td>
<td>0.003</td>
<td>0.000</td>
<td>0.029000</td>
<td>0.005</td>
<td>0.010</td>
<td>0.003000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">599998</td>
<td>U3462916</td>
<td>no</td>
<td>0</td>
<td>team</td>
<td>&lt; 30</td>
<td>no</td>
<td>50000</td>
<td>35</td>
<td>0.6</td>
<td>2</td>
<td>...</td>
<td>-0.042065</td>
<td>-0.000051</td>
<td>0.011000</td>
<td>0.002</td>
<td>0.005</td>
<td>0.011</td>
<td>0.001000</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">599999</td>
<td>U3462922</td>
<td>no</td>
<td>0</td>
<td>endurance</td>
<td>30 to 44</td>
<td>yes</td>
<td>50000</td>
<td>25</td>
<td>0.7</td>
<td>1</td>
<td>...</td>
<td>0.483980</td>
<td>0.000514</td>
<td>0.021667</td>
<td>0.002</td>
<td>0.000</td>
<td>0.005</td>
<td>0.002000</td>
<td>0.001</td>
<td>0.003</td>
<td>0.021667</td>
</tr>
</tbody>
</table>

<p>600000 rows × 92 columns</p>
</div>
</div>
</div>
</div>
<p>To identify which message will lead to the highest probability of purchase, we will use our random forest model to extrapolate predictions to the full database.</p>
<div id="917a9298" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_rf"</span>: <span class="st">"control"</span>, </span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_rf"</span>: <span class="st">"endurance"</span>, </span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_rf"</span>: <span class="st">"backcountry"</span>, </span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_rf"</span>: <span class="st">"racquet"</span>, </span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_rf"</span>: <span class="st">"strength"</span>, </span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_rf"</span>: <span class="st">"team"</span>, </span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_rf"</span>: <span class="st">"water"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0b3b1bb2" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>predictions_rf <span class="op">=</span> [</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_rf"</span>, </span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_rf"</span>, </span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_rf"</span>, </span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_rf"</span>, </span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_rf"</span>, </span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_rf"</span>, </span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_rf"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0503ee62" class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'message_rf'</span>] <span class="op">=</span> (</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[predictions_rf]</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code above is creating a new column in our Pentathlon_NPTB database, called <code>message_rf</code> which identifies which of the predicted messages has the highest probability, and then filling in the <code>message_rf</code> column with the name of the message that has the highest probability.</p>
<div id="6d734be5" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the distribution of message_rf column</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'message_rf'</span>].value_counts().plot(kind<span class="op">=</span><span class="st">'bar'</span>, title <span class="op">=</span> <span class="st">'Distribution of message_rf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-124-output-1.png" width="602" height="520" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a2aa7d48" class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'p_max_rf'</span>] <span class="op">=</span> pentathlon_nptb[predictions_rf].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Approach</strong> <br> Our approach to creating the targeting messaging is building a random forest model to predict the next product the customer will buy based on a variety of customer features. We will use buyer_yes as the response variable and the other variables as predictors.</p>
<p>We use our random forest model to extend the prediction to the full database. To predict the probability of purchasing for different messages, we use the <code>data_cmd</code> to predict the probability of purchasing for different messages.</p>
<p>Finally, we select the product with the highest probability using <code>idxmax</code>. This command also provides a label for the category with the maximum predicted probability of buying across all the products. Then, create <code>p_max</code> to store the maximum predicted probability of purchasing an item based on the messaging sent to said customer.</p>
</section>
</section>
<section id="percentage-of-customers-to-message-and-not-to-message" class="level3">
<h3 class="anchored" data-anchor-id="percentage-of-customers-to-message-and-not-to-message">2. Percentage of customers to message and not to message</h3>
<div id="ac0f8bfe" class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].message_rf, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="125">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">message_rf</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>18,952</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">control</td>
<td>53,019</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">endurance</td>
<td>29,327</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">racquet</td>
<td>18,859</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">strength</td>
<td>23,927</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">team</td>
<td>18,809</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">water</td>
<td>17,107</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="e0fb49b3" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'message_rf'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>message_rf
control        0.299772
endurance      0.162343
strength       0.132712
racquet        0.104497
backcountry    0.103977
team           0.102348
water          0.094352
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<ul>
<li><p><code>control</code>: The distribution suggests that the <code>control_rf</code> control messaging seems to resonate more with the customers than the other messages based on this model.</p></li>
<li><p><code>endurance</code>, <code>strength</code>: the <code>endurance</code> and <code>strength</code> messages are approximately similar in their values. There might be opportunities to further optimize or tailor these messages to increase their effectiveness.</p></li>
<li><p><code>backcountry</code>, <code>racquet</code>, <code>water</code>, <code>team</code>, all have roughly the same proportion of customers to message at around 10%. This suggests that these messages are not as effective as the <code>control</code> and <code>endurance</code> messages.</p></li>
</ul>
<div id="3e15454e" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'message_rf'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>).plot(kind<span class="op">=</span><span class="st">'bar'</span>, title<span class="op">=</span><span class="st">'Message Distribution'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-128-output-1.png" width="581" height="520" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="7dc2c5c4" class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, predictions_rf].agg(<span class="st">"mean"</span>).sort_values(</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>    ascending<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(rsm.format_nr, perc<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>p_endurance_rf      2.91%
p_strength_rf       2.79%
p_water_rf          2.63%
p_team_rf           2.61%
p_backcountry_rf    2.55%
p_racquet_rf        2.55%
p_control_rf        2.43%
dtype: object</code></pre>
</div>
</div>
<p>Above is a table with the average purchase probability if we send the message for each product to everyone. Even though we are sending much more control messages compared to the other categories, we see that this does not lead to an increase in the probability of purchase. This is an interesting insight, and we should consider other ways to optimize our messaging strategy to increase the number of messages sent to those in the <code>endurance</code> and <code>strength</code> categories.</p>
</section>
<section id="expected-profit-2" class="level3">
<h3 class="anchored" data-anchor-id="expected-profit-2">3. Expected profit</h3>
<div id="3c4e6636" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Average Ordersize per message</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>ordersize <span class="op">=</span> pentathlon_nptb[(pentathlon_nptb.training <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pentathlon_nptb.buyer_yes <span class="op">==</span> <span class="dv">1</span>)].groupby(<span class="st">"message_rf"</span>)[<span class="st">"total_os"</span>].mean()</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>ordersize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre><code>message_rf
backcountry    64.065387
control        49.908751
endurance      55.584893
racquet        56.416727
strength       56.684246
team           56.522449
water          61.926676
Name: total_os, dtype: float64</code></pre>
</div>
</div>
<section id="create-another-random-forest-model-to-predict-the-ordersize" class="level4">
<h4 class="anchored" data-anchor-id="create-another-random-forest-model-to-predict-the-ordersize">Create another random forest model to Predict the Ordersize</h4>
<div id="5c5c395f" class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>rf_os <span class="op">=</span> rsm.model.rforest(</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {<span class="st">"pentathlon_nptb"</span>: pentathlon_nptb[(pentathlon_nptb.training <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pentathlon_nptb.buyer <span class="op">==</span> <span class="st">"yes"</span>)]},</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>    rvar <span class="op">=</span><span class="st">"total_os"</span>,</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    evar <span class="op">=</span> evar,</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    n_estimators <span class="op">=</span> <span class="dv">200</span>,</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>    max_features <span class="op">=</span> <span class="st">'sqrt'</span></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>rf_os.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest
Data                 : pentathlon_nptb
Response variable    : total_os
Level                : None
Explanatory variables: message, age, female, income, education, children, freq_endurance, freq_strength, freq_water, freq_team, freq_backcountry, freq_racquet
OOB                  : True
Model type           : classification
Nr. of features      : (12, 21)
Nr. of observations  : 10,080
max_features         : sqrt (4)
n_estimators         : 200
min_samples_leaf     : 1
random_state         : 1234
AUC                  : nan

Estimation data      :
 income  education  children  freq_endurance  freq_strength  freq_water  freq_team  freq_backcountry  freq_racquet  message_backcountry  message_control  message_endurance  message_racquet  message_strength  message_team  message_water  age_&lt; 30  age_30 to 44  age_45 to 59  age_&gt;= 60  female_no
  65000         52       0.5               3              0           0          2                 1             3                False            False               True            False             False         False          False     False         False          True      False       True
  55000         43       0.2               1              2           0          0                 2             0                False             True              False            False             False         False          False     False         False          True      False       True
 160000         82       1.3              13              5           0         15                 5             2                 True            False              False            False             False         False          False     False          True         False      False       True
  90000         60       1.2               7              2           2          5                 0             1                 True            False              False            False             False         False          False     False         False          True      False       True
  55000         40       0.7               0              1           0          1                 1             0                False            False              False            False              True         False          False     False          True         False      False       True</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/duyentran/Library/Python/3.11/lib/python/site-packages/pyrsm/model/perf.py:1240: RuntimeWarning:

invalid value encountered in scalar divide
</code></pre>
</div>
</div>
<div id="4e1346d2" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_control_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"control"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_racquet_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"racquet"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_team_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"team"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_backcountry_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"backcountry"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_water_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"water"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_strength_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"strength"</span>})[<span class="st">"prediction"</span>]</span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'pos_endurance_rf'</span>] <span class="op">=</span> rf_os.predict(pentathlon_nptb, data_cmd<span class="op">=</span>{<span class="st">"message"</span>: <span class="st">"endurance"</span>})[<span class="st">"prediction"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculating-the-expected-profit-for-each-product" class="level4">
<h4 class="anchored" data-anchor-id="calculating-the-expected-profit-for-each-product">Calculating the expected profit for each product</h4>
<div id="61cc1247" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_control_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_control_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_control_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_racquet_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_racquet_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_racquet_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_team_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_team_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_team_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_backcountry_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_backcountry_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_backcountry_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_water_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_water_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_water_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_strength_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_strength_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_strength_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_endurance_rf'</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">'p_endurance_rf'</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">'pos_endurance_reg'</span>] <span class="op">*</span> <span class="fl">0.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2d0aaa7d" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>expected_profit_rf <span class="op">=</span> [</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_control_rf"</span>, </span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_endurance_rf"</span>, </span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_backcountry_rf"</span>, </span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_racquet_rf"</span>, </span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_strength_rf"</span>, </span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_team_rf"</span>, </span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_water_rf"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6986c66a" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {<span class="st">"ep_control_rf"</span>: <span class="st">"control"</span>, <span class="st">"ep_endurance_rf"</span>: <span class="st">"endurance"</span>, <span class="st">"ep_backcountry_rf"</span>: <span class="st">"backcountry"</span>, <span class="st">"ep_racquet_rf"</span>: <span class="st">"racquet"</span>, <span class="st">"ep_strength_rf"</span>: <span class="st">"strength"</span>, <span class="st">"ep_team_rf"</span>: <span class="st">"team"</span>, <span class="st">"ep_water_rf"</span>: <span class="st">"water"</span>}</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_message_rf"</span>] <span class="op">=</span> (</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[expected_profit_rf]</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_message_rf'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="134">
<pre><code>ep_message_rf
control        171206
endurance       88843
water           72279
strength        71154
backcountry     68671
team            65027
racquet         62820
Name: count, dtype: int64</code></pre>
</div>
</div>
<section id="percentage-of-customer-for-whom-no-message-maximizes-their-expected-profits" class="level5">
<h5 class="anchored" data-anchor-id="percentage-of-customer-for-whom-no-message-maximizes-their-expected-profits">4. Percentage of customer for whom no message maximizes their expected profits</h5>
<div id="0f69b10a" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb.ep_message_rf.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>ep_message_rf
control        0.285343
endurance      0.148072
water          0.120465
strength       0.118590
backcountry    0.114452
team           0.108378
racquet        0.104700
Name: proportion, dtype: float64</code></pre>
</div>
</div>
</section>
</section>
<section id="expected-profit-per-email-if-we-customize-the-message-to-each-customers" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit-per-email-if-we-customize-the-message-to-each-customers">5. Expected profit per email if we customize the message to each customers</h4>
<div id="74049bfd" class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max_rf"</span>] <span class="op">=</span> pentathlon_nptb[expected_profit_rf].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max_rf"</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="136">
<pre><code>1.0516237742883443</code></pre>
</div>
</div>
<div id="06c05c90" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].ep_message_rf, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ep_message_rf</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>21,405</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">control</td>
<td>50,280</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">endurance</td>
<td>26,442</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">racquet</td>
<td>18,786</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">strength</td>
<td>21,082</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">team</td>
<td>19,690</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">water</td>
<td>22,315</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message-2" class="level4">
<h4 class="anchored" data-anchor-id="expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message-2">6. Expected profit per e-mailed customer if every customer receives the same message</h4>
<div id="5cd23662" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>    .loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, expected_profit_rf]</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>    .agg(<span class="st">"mean"</span>)</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(rsm.format_nr, sym <span class="op">=</span> <span class="st">"$"</span>, dec <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<pre><code>ep_water_rf          $0.65
ep_backcountry_rf    $0.65
ep_endurance_rf      $0.64
ep_strength_rf       $0.63
ep_team_rf           $0.58
ep_racquet_rf        $0.58
ep_control_rf        $0.49
dtype: object</code></pre>
</div>
</div>
</section>
</section>
<section id="expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition-1" class="level3">
<h3 class="anchored" data-anchor-id="expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition-1">7. Expected profit per e-mailed customer if every customer is assigned randomly to one of the messages or the no-message condition</h3>
<div id="e445e05d" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probabilty of purchase where customer is assigned to a random message</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"p_random_rf"</span>] <span class="op">=</span> rf.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected avg order size where customer is assigned to a random message</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ordersize_random_reg"</span>] <span class="op">=</span> reg.predict(pentathlon_nptb)[<span class="st">"prediction"</span>]</span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit when customer is assigned to a random message</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_random_rf"</span>] <span class="op">=</span> pentathlon_nptb[<span class="st">"p_random_rf"</span>] <span class="op">*</span> pentathlon_nptb[<span class="st">"ordersize_random_reg"</span>] <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit/customer when a customer is assigned to a random message</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>random_profit_per_customer_rf <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_random_rf"</span>].mean()</span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>random_profit_per_customer_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="139">
<pre><code>0.5981461370014217</code></pre>
</div>
</div>
<div id="69715e9e" class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit where no-message is sent (control)</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_control_rf"</span>]</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit per customer where no-message is sent (control)</span></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer_rf <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_control_rf"</span>].mean()</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>0.48744714166587705</code></pre>
</div>
</div>
<section id="profit-for-5000000-customers-1" class="level4">
<h4 class="anchored" data-anchor-id="profit-for-5000000-customers-1">8. Profit for 5,000,000 customers</h4>
<div id="6f3b73df" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>profit_rf <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_max_rf"</span>].agg(<span class="st">"mean"</span>) <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>profit_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre><code>4947465.355117234</code></pre>
</div>
</div>
<div id="da956a37" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit when a customer is sent a random message</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>random_profit_rf <span class="op">=</span> random_profit_per_customer_rf <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>random_profit_rf</span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit when there is no message sent</span></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>control_profit_rf <span class="op">=</span> control_profit_per_customer_rf <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>control_profit_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre><code>2437235.708329385</code></pre>
</div>
</div>
<div id="79564123" class="cell" data-execution_count="143">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>profit_improvement_rf <span class="op">=</span> profit_rf <span class="op">-</span> control_profit_rf</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>profit_improvement_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="143">
<pre><code>2510229.6467878493</code></pre>
</div>
</div>
<div id="8863123f" class="cell" data-execution_count="144">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>profits_dct_rf <span class="op">=</span> {</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Customize Message"</span>: profit_rf,</span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Randomly Assign"</span>: random_profit_rf,</span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Message Sent"</span>: control_profit_rf,</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dictionary to DataFrame</span></span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(profits_dct_rf.items()), columns<span class="op">=</span>[<span class="st">'Model'</span>, <span class="st">'Profit'</span>])</span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))  <span class="co"># Adjust the width and height to your preference</span></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb226-15"><a href="#cb226-15" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"white"</span>)</span>
<span id="cb226-16"><a href="#cb226-16" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"Model"</span>, y<span class="op">=</span><span class="st">"Profit"</span>, data<span class="op">=</span>df, palette<span class="op">=</span><span class="st">"coolwarm"</span>)</span>
<span id="cb226-17"><a href="#cb226-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-18"><a href="#cb226-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotations</span></span>
<span id="cb226-19"><a href="#cb226-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb226-20"><a href="#cb226-20" aria-hidden="true" tabindex="-1"></a>    ax.text(index, row.Profit, <span class="ss">f'$</span><span class="sc">{</span>row<span class="sc">.</span>Profit<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb226-21"><a href="#cb226-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-22"><a href="#cb226-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb226-23"><a href="#cb226-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Model Type"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb226-24"><a href="#cb226-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Profit"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb226-25"><a href="#cb226-25" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Profit by Model"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">15</span>})</span>
<span id="cb226-26"><a href="#cb226-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-27"><a href="#cb226-27" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate x labels for better readability</span></span>
<span id="cb226-28"><a href="#cb226-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/2755170672.py:16: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-145-output-2.png" width="805" height="549" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="xgboost-model" class="level2">
<h2 class="anchored" data-anchor-id="xgboost-model">XGBoost Model</h2>
<div id="244e7c3e" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>rvar <span class="op">=</span> <span class="st">"buyer_yes"</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> pentathlon_nptb.columns.to_list()</span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> evar[evar.index(<span class="st">"message"</span>):] <span class="co"># all columns after "message"</span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> evar[:evar.index(<span class="st">"freq_racquet"</span>)<span class="op">+</span><span class="dv">1</span>] <span class="co"># all columns before "freq_racquet"</span></span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>evar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre><code>['message',
 'age',
 'female',
 'income',
 'education',
 'children',
 'freq_endurance',
 'freq_strength',
 'freq_water',
 'freq_team',
 'freq_backcountry',
 'freq_racquet']</code></pre>
</div>
</div>
<div id="19469549" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create X_train, X_test, y_train, y_test using "training" column</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">1</span>, evar]</span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">0</span>, evar]</span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">1</span>, rvar]</span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">0</span>, rvar]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ca8185d1" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameter grid to be used in RandomizedSearchCV</span></span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learning_rate'</span>: [<span class="fl">0.1</span>,<span class="fl">0.01</span>,<span class="fl">0.001</span>],  </span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">100</span>],</span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">3</span>, <span class="dv">6</span> ,<span class="dv">10</span> ] <span class="co"># Depths from 3 to 10</span></span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bc7b1f65" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the XGBClassifier</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>xgb <span class="op">=</span> XGBClassifier(use_label_encoder<span class="op">=</span><span class="va">False</span>, eval_metric<span class="op">=</span><span class="st">'logloss'</span>,enable_categorical <span class="op">=</span> <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="37fc15f8" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize GridSearchCV</span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>xgb_tuned <span class="op">=</span> GridSearchCV(estimator<span class="op">=</span>xgb, param_grid<span class="op">=</span> param_grid, scoring<span class="op">=</span><span class="st">'roc_auc'</span>, cv<span class="op">=</span><span class="dv">5</span>, verbose<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="16d05933" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>xgb_tuned.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting 5 folds for each of 9 candidates, totalling 45 fits
[CV 1/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=0.889 total time=   0.8s
[CV 2/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=0.884 total time=   0.7s
[CV 3/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=0.890 total time=   0.7s
[CV 4/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=0.882 total time=   0.7s
[CV 5/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=0.880 total time=   0.7s
[CV 1/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=0.891 total time=   1.1s
[CV 2/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=0.886 total time=   1.1s
[CV 3/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=0.892 total time=   1.1s
[CV 4/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=0.884 total time=   1.1s
[CV 5/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=0.881 total time=   1.1s
[CV 1/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=0.884 total time=   1.6s
[CV 2/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=0.879 total time=   1.8s
[CV 3/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=0.885 total time=   1.6s
[CV 4/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=0.875 total time=   1.7s
[CV 5/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=0.874 total time=   1.6s
[CV 1/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=0.864 total time=   0.6s
[CV 2/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=0.864 total time=   0.6s
[CV 3/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=0.870 total time=   0.6s
[CV 4/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=0.856 total time=   0.6s
[CV 5/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=0.854 total time=   0.6s
[CV 1/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=0.880 total time=   1.0s
[CV 2/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=0.876 total time=   1.0s
[CV 3/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=0.882 total time=   1.0s
[CV 4/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=0.873 total time=   1.0s
[CV 5/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=0.870 total time=   1.0s
[CV 1/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=0.882 total time=   1.6s
[CV 2/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=0.876 total time=   1.6s
[CV 3/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=0.885 total time=   1.6s
[CV 4/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=0.877 total time=   1.6s
[CV 5/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=0.875 total time=   1.7s
[CV 1/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=0.850 total time=   0.6s
[CV 2/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=0.840 total time=   0.5s
[CV 3/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=0.848 total time=   0.6s
[CV 4/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=0.837 total time=   0.6s
[CV 5/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=0.837 total time=   0.5s
[CV 1/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=0.874 total time=   1.0s
[CV 2/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=0.869 total time=   1.0s
[CV 3/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=0.876 total time=   1.0s
[CV 4/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=0.867 total time=   0.9s
[CV 5/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=0.866 total time=   0.9s
[CV 1/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=0.874 total time=   1.5s
[CV 2/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=0.869 total time=   1.6s
[CV 3/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=0.880 total time=   1.5s
[CV 4/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=0.864 total time=   1.4s
[CV 5/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=0.868 total time=   1.5s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="150">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</a></style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>GridSearchCV(cv=5,
             estimator=XGBClassifier(base_score=None, booster=None,
                                     callbacks=None, colsample_bylevel=None,
                                     colsample_bynode=None,
                                     colsample_bytree=None, device=None,
                                     early_stopping_rounds=None,
                                     enable_categorical=True,
                                     eval_metric='logloss', feature_types=None,
                                     gamma=None, grow_policy=None,
                                     importance_type=None,
                                     interaction_constraints=None,
                                     learning_rate=N...
                                     max_cat_threshold=None,
                                     max_cat_to_onehot=None,
                                     max_delta_step=None, max_depth=None,
                                     max_leaves=None, min_child_weight=None,
                                     missing=nan, monotone_constraints=None,
                                     multi_strategy=None, n_estimators=None,
                                     n_jobs=None, num_parallel_tree=None,
                                     random_state=None, ...),
             param_grid={'learning_rate': [0.1, 0.01, 0.001],
                         'max_depth': [3, 6, 10], 'n_estimators': [100]},
             scoring='roc_auc', verbose=5)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;GridSearchCV<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.4/modules/generated/sklearn.model_selection.GridSearchCV.html">?<span>Documentation for GridSearchCV</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>GridSearchCV(cv=5,
             estimator=XGBClassifier(base_score=None, booster=None,
                                     callbacks=None, colsample_bylevel=None,
                                     colsample_bynode=None,
                                     colsample_bytree=None, device=None,
                                     early_stopping_rounds=None,
                                     enable_categorical=True,
                                     eval_metric='logloss', feature_types=None,
                                     gamma=None, grow_policy=None,
                                     importance_type=None,
                                     interaction_constraints=None,
                                     learning_rate=N...
                                     max_cat_threshold=None,
                                     max_cat_to_onehot=None,
                                     max_delta_step=None, max_depth=None,
                                     max_leaves=None, min_child_weight=None,
                                     missing=nan, monotone_constraints=None,
                                     multi_strategy=None, n_estimators=None,
                                     n_jobs=None, num_parallel_tree=None,
                                     random_state=None, ...),
             param_grid={'learning_rate': [0.1, 0.01, 0.001],
                         'max_depth': [3, 6, 10], 'n_estimators': [100]},
             scoring='roc_auc', verbose=5)</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">estimator: XGBClassifier</label><div class="sk-toggleable__content fitted"><pre>XGBClassifier(base_score=None, booster=None, callbacks=None,
              colsample_bylevel=None, colsample_bynode=None,
              colsample_bytree=None, device=None, early_stopping_rounds=None,
              enable_categorical=True, eval_metric='logloss',
              feature_types=None, gamma=None, grow_policy=None,
              importance_type=None, interaction_constraints=None,
              learning_rate=None, max_bin=None, max_cat_threshold=None,
              max_cat_to_onehot=None, max_delta_step=None, max_depth=None,
              max_leaves=None, min_child_weight=None, missing=nan,
              monotone_constraints=None, multi_strategy=None, n_estimators=None,
              n_jobs=None, num_parallel_tree=None, random_state=None, ...)</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">XGBClassifier</label><div class="sk-toggleable__content fitted"><pre>XGBClassifier(base_score=None, booster=None, callbacks=None,
              colsample_bylevel=None, colsample_bynode=None,
              colsample_bytree=None, device=None, early_stopping_rounds=None,
              enable_categorical=True, eval_metric='logloss',
              feature_types=None, gamma=None, grow_policy=None,
              importance_type=None, interaction_constraints=None,
              learning_rate=None, max_bin=None, max_cat_threshold=None,
              max_cat_to_onehot=None, max_delta_step=None, max_depth=None,
              max_leaves=None, min_child_weight=None, missing=nan,
              monotone_constraints=None, multi_strategy=None, n_estimators=None,
              n_jobs=None, num_parallel_tree=None, random_state=None, ...)</pre></div> </div></div></div></div></div></div></div></div></div>
</div>
</div>
<div id="595f254c" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print best parameters</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a>best_params <span class="op">=</span> xgb_tuned.best_params_</span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(best_params)</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print best score</span></span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>best_score <span class="op">=</span> xgb_tuned.best_score_</span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(best_score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'learning_rate': 0.1, 'max_depth': 6, 'n_estimators': 100}
0.886970840782522</code></pre>
</div>
</div>
<div id="3c3301b8" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train model on best parameters</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>best_xgb <span class="op">=</span> XGBClassifier(<span class="op">**</span>best_params, use_label_encoder<span class="op">=</span><span class="va">False</span>, eval_metric<span class="op">=</span><span class="st">"logloss"</span>, enable_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit new model to training data</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>best_xgb.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<style>#sk-container-id-2 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-2 {
  color: var(--sklearn-color-text);
}

#sk-container-id-2 pre {
  padding: 0;
}

#sk-container-id-2 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-2 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-2 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-2 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-2 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-2 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-2 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-2 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-2 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-2 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-2 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-2 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-2 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-2 div.sk-label label.sk-toggleable__label,
#sk-container-id-2 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-2 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-2 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-2 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-2 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-2 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-2 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-2 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-2 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-2 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</a></style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>XGBClassifier(base_score=None, booster=None, callbacks=None,
              colsample_bylevel=None, colsample_bynode=None,
              colsample_bytree=None, device=None, early_stopping_rounds=None,
              enable_categorical=True, eval_metric='logloss',
              feature_types=None, gamma=None, grow_policy=None,
              importance_type=None, interaction_constraints=None,
              learning_rate=0.1, max_bin=None, max_cat_threshold=None,
              max_cat_to_onehot=None, max_delta_step=None, max_depth=6,
              max_leaves=None, min_child_weight=None, missing=nan,
              monotone_constraints=None, multi_strategy=None, n_estimators=100,
              n_jobs=None, num_parallel_tree=None, random_state=None, ...)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox" checked=""><label for="sk-estimator-id-4" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;XGBClassifier<span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>XGBClassifier(base_score=None, booster=None, callbacks=None,
              colsample_bylevel=None, colsample_bynode=None,
              colsample_bytree=None, device=None, early_stopping_rounds=None,
              enable_categorical=True, eval_metric='logloss',
              feature_types=None, gamma=None, grow_policy=None,
              importance_type=None, interaction_constraints=None,
              learning_rate=0.1, max_bin=None, max_cat_threshold=None,
              max_cat_to_onehot=None, max_delta_step=None, max_depth=6,
              max_leaves=None, min_child_weight=None, missing=nan,
              monotone_constraints=None, multi_strategy=None, n_estimators=100,
              n_jobs=None, num_parallel_tree=None, random_state=None, ...)</pre></div> </div></div></div></div>
</div>
</div>
<div id="aa8917af" class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature importance of xgb model</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> plot_importance</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming best_xgb is your trained XGBoost model</span></span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot feature importance</span></span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a>plot_importance(best_xgb, importance_type<span class="op">=</span><span class="st">'weight'</span>)</span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-154-output-1.png" width="700" height="455" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="questions" class="level2">
<h2 class="anchored" data-anchor-id="questions">Questions</h2>
<section id="for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase." class="level3">
<h3 class="anchored" data-anchor-id="for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-probability-of-purchase.">1. For each customer determine the message (i.e., endurance, strength, water, team, backcountry, racquet, or no-message) predicted to lead to the highest probability of purchase.</h3>
<p>To determine the message that will lead to the highest probability of purchase for each customer, we can fit the model using only the data for each categorical level in our model and use the fitted model to create predictions for all of the data. Once we have predictions on all of the data for each message, we can select the message with the highest predicted value for the record.</p>
<div id="245f7c02" class="cell" data-execution_count="154">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a training copy of the data where 'training' equals 1</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb_train <span class="op">=</span> pentathlon_nptb[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the 7 different "message" values</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>message_values <span class="op">=</span> [<span class="st">'team'</span>, <span class="st">'backcountry'</span>, <span class="st">'endurance'</span>, <span class="st">'water'</span>, <span class="st">'racquet'</span>, <span class="st">'strength'</span>, <span class="st">'control'</span>]</span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> value <span class="kw">in</span> message_values:</span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the training set for the current message</span></span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a>    current_train <span class="op">=</span> pentathlon_nptb_train[pentathlon_nptb_train[<span class="st">'message'</span>] <span class="op">==</span> value]</span>
<span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create X_train and y_train for the current message</span></span>
<span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> current_train[evar]</span>
<span id="cb240-13"><a href="#cb240-13" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> current_train[rvar]</span>
<span id="cb240-14"><a href="#cb240-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-15"><a href="#cb240-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the model to the training data for the current message</span></span>
<span id="cb240-16"><a href="#cb240-16" aria-hidden="true" tabindex="-1"></a>    best_xgb.fit(X_train, y_train)</span>
<span id="cb240-17"><a href="#cb240-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-18"><a href="#cb240-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict probabilities for the entire dataset (you may want to adjust this based on your requirements)</span></span>
<span id="cb240-19"><a href="#cb240-19" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[<span class="ss">f'p_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">_xgb'</span>] <span class="op">=</span> best_xgb.predict_proba(pentathlon_nptb[evar])[:, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1516221055.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1516221055.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1516221055.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1516221055.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1516221055.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1516221055.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
</div>
<div id="7fe41a24" class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_xgb"</span>: <span class="st">"control"</span>, </span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_xgb"</span>: <span class="st">"endurance"</span>, </span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_xgb"</span>: <span class="st">"backcountry"</span>, </span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_xgb"</span>: <span class="st">"racquet"</span>, </span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_xgb"</span>: <span class="st">"strength"</span>, </span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_xgb"</span>: <span class="st">"team"</span>, </span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_xgb"</span>: <span class="st">"water"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c6ed783e" class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>predictions_xgb <span class="op">=</span> [</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_control_xgb"</span>, </span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_endurance_xgb"</span>, </span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_backcountry_xgb"</span>, </span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_racquet_xgb"</span>, </span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_strength_xgb"</span>, </span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_team_xgb"</span>, </span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_water_xgb"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="82b2383e" class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'message_xgb'</span>] <span class="op">=</span> (</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[predictions_xgb]</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/3215817490.py:1: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
</div>
<div id="19c7c3ff" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(index<span class="op">=</span>pentathlon_nptb.message_xgb, columns<span class="op">=</span><span class="st">"count"</span>).<span class="bu">apply</span>(rsm.format_nr).sort_values(<span class="st">"count"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="158">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">col_0</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">message_xgb</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">endurance</td>
<td>179,225</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">backcountry</td>
<td>56,966</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">control</td>
<td>58,865</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">water</td>
<td>64,209</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">racquet</td>
<td>70,013</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">team</td>
<td>71,928</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">strength</td>
<td>98,794</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="for-each-message-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase" class="level3">
<h3 class="anchored" data-anchor-id="for-each-message-the-percentage-of-customers-for-whom-that-message-or-no-message-maximizes-their-probability-of-purchase">2. For each message, The percentage of customers for whom that message or no-message maximizes their probability of purchase:</h3>
<p>We can see from the plot that endurance messages most often maximizes the cusomer’s probability of purchase. After enducance, strength messages are the second most reported value that maximizes purchase probabilities. Surprisingly, despite team, raquet, and water being the next best message groups, none of the remaining messages seem to provide a meaningful improvement over sending no message at all.</p>
<div id="004fd148" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>message_percentages<span class="op">=</span> pentathlon_nptb[<span class="st">'message_xgb'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>message_percentages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="159">
<pre><code>message_xgb
endurance      0.298708
strength       0.164657
team           0.119880
racquet        0.116688
water          0.107015
control        0.098108
backcountry    0.094943
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<div id="0d61bd7b" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>message_percentages.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Percentage of Customers'</span>)</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Message Type'</span>)</span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Percentage of Customers for Each Message Value'</span>)</span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate labels to make them readable</span></span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-161-output-1.png" width="824" height="581" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-expected-profit-cogs-is-60." class="level3">
<h3 class="anchored" data-anchor-id="for-each-customer-determine-the-message-i.e.-endurance-strength-water-team-backcountry-racquet-or-no-message-predicted-to-lead-to-the-highest-expected-profit-cogs-is-60.">For each customer, determine the message (i.e., endurance, strength, water, team, backcountry, racquet, or no-message) predicted to lead to the highest expected profit (COGS is 60%).</h3>
<p>The message returning the highest profit is <code>Endurance</code></p>
<p>To predict order size we tuned a new xgb model to the data and regressed the likely order size for each record. We then used the predicted order size to calculate the expected profit for each record. We calculated the expected profit by multiplying the predicted order size by the probability of purchase and subtracting the cost of goods sold from the result.</p>
<div id="6f2fcb01" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>rvar_os <span class="op">=</span> <span class="st">"total_os"</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>evar <span class="op">=</span> [<span class="st">'message'</span>,</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'age'</span>,</span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a> <span class="st">'female'</span>,</span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a> <span class="st">'income'</span>,</span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a> <span class="st">'education'</span>,</span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a> <span class="st">'children'</span>,</span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a> <span class="st">'freq_endurance'</span>,</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a> <span class="st">'freq_strength'</span>,</span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a> <span class="st">'freq_water'</span>,</span>
<span id="cb250-11"><a href="#cb250-11" aria-hidden="true" tabindex="-1"></a> <span class="st">'freq_team'</span>,</span>
<span id="cb250-12"><a href="#cb250-12" aria-hidden="true" tabindex="-1"></a> <span class="st">'freq_backcountry'</span>,</span>
<span id="cb250-13"><a href="#cb250-13" aria-hidden="true" tabindex="-1"></a> <span class="st">'freq_racquet'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ea13ba58" class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create X_train, X_test, y_train, y_test using "training" column</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">1</span>, evar]</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">0</span>, evar]</span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>y_train_os <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">'total_os'</span>]</span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>y_test_os <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">'total_os'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ebeeeb8b" class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the parameter grid to be used in GridSearchCV</span></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learning_rate'</span>: [<span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>],  </span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">100</span>],</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">10</span>]  <span class="co"># Depths from 3 to 10</span></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the XGBRegressor</span></span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>xgb_os <span class="op">=</span> XGBRegressor(use_label_encoder<span class="op">=</span><span class="va">False</span>, eval_metric<span class="op">=</span><span class="st">'rmse'</span>, enable_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize GridSearchCV with a scoring metric suitable for regression</span></span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a>xgb_tuned_os <span class="op">=</span> GridSearchCV(estimator<span class="op">=</span>xgb_os, param_grid<span class="op">=</span>param_grid, scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>, cv<span class="op">=</span><span class="dv">5</span>, verbose<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming X_train and y_train are defined</span></span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb252-18"><a href="#cb252-18" aria-hidden="true" tabindex="-1"></a>xgb_tuned_os.fit(X_train, y_train_os)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting 5 folds for each of 9 candidates, totalling 45 fits
[CV 1/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=-12.399 total time=   0.4s
[CV 2/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=-12.532 total time=   0.4s
[CV 3/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=-12.659 total time=   0.4s
[CV 4/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=-12.504 total time=   0.4s
[CV 5/5] END learning_rate=0.1, max_depth=3, n_estimators=100;, score=-11.961 total time=   0.5s
[CV 1/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=-12.700 total time=   0.6s
[CV 2/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=-12.639 total time=   0.7s
[CV 3/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=-12.807 total time=   0.7s
[CV 4/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=-12.660 total time=   0.7s
[CV 5/5] END learning_rate=0.1, max_depth=6, n_estimators=100;, score=-12.062 total time=   0.7s
[CV 1/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=-13.273 total time=   1.1s
[CV 2/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=-13.104 total time=   1.2s
[CV 3/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=-13.254 total time=   1.1s
[CV 4/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=-12.978 total time=   1.3s
[CV 5/5] END learning_rate=0.1, max_depth=10, n_estimators=100;, score=-12.550 total time=   1.2s
[CV 1/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=-12.550 total time=   0.4s
[CV 2/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=-12.691 total time=   0.4s
[CV 3/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=-12.816 total time=   0.4s
[CV 4/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=-12.654 total time=   0.4s
[CV 5/5] END learning_rate=0.01, max_depth=3, n_estimators=100;, score=-12.135 total time=   0.4s
[CV 1/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=-12.568 total time=   0.8s
[CV 2/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=-12.663 total time=   0.7s
[CV 3/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=-12.795 total time=   0.9s
[CV 4/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=-12.622 total time=   0.8s
[CV 5/5] END learning_rate=0.01, max_depth=6, n_estimators=100;, score=-12.095 total time=   0.8s
[CV 1/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=-12.658 total time=   1.5s
[CV 2/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=-12.755 total time=   1.5s
[CV 3/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=-12.850 total time=   1.4s
[CV 4/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=-12.661 total time=   1.4s
[CV 5/5] END learning_rate=0.01, max_depth=10, n_estimators=100;, score=-12.113 total time=   1.5s
[CV 1/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=-12.971 total time=   0.4s
[CV 2/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=-13.065 total time=   0.4s
[CV 3/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=-13.206 total time=   0.4s
[CV 4/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=-13.016 total time=   0.4s
[CV 5/5] END learning_rate=0.001, max_depth=3, n_estimators=100;, score=-12.524 total time=   0.5s
[CV 1/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=-12.966 total time=   0.8s
[CV 2/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=-13.058 total time=   0.8s
[CV 3/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=-13.195 total time=   0.7s
[CV 4/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=-13.005 total time=   0.7s
[CV 5/5] END learning_rate=0.001, max_depth=6, n_estimators=100;, score=-12.511 total time=   0.8s
[CV 1/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=-12.957 total time=   1.6s
[CV 2/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=-13.059 total time=   1.6s
[CV 3/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=-13.197 total time=   1.5s
[CV 4/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=-13.001 total time=   1.8s
[CV 5/5] END learning_rate=0.001, max_depth=10, n_estimators=100;, score=-12.500 total time=   1.6s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="163">
<style>#sk-container-id-3 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-3 {
  color: var(--sklearn-color-text);
}

#sk-container-id-3 pre {
  padding: 0;
}

#sk-container-id-3 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-3 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-3 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-3 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-3 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-3 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-3 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-3 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-3 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-3 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-3 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-3 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-3 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-3 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-3 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-3 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-3 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-3 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-3 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-3 div.sk-label label.sk-toggleable__label,
#sk-container-id-3 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-3 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-3 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-3 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-3 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-3 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-3 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-3 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-3 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-3 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-3 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-3 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-3 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</a></style><div id="sk-container-id-3" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>GridSearchCV(cv=5,
             estimator=XGBRegressor(base_score=None, booster=None,
                                    callbacks=None, colsample_bylevel=None,
                                    colsample_bynode=None,
                                    colsample_bytree=None, device=None,
                                    early_stopping_rounds=None,
                                    enable_categorical=True, eval_metric='rmse',
                                    feature_types=None, gamma=None,
                                    grow_policy=None, importance_type=None,
                                    interaction_constraints=None,
                                    learning_rate=None,...
                                    max_cat_to_onehot=None, max_delta_step=None,
                                    max_depth=None, max_leaves=None,
                                    min_child_weight=None, missing=nan,
                                    monotone_constraints=None,
                                    multi_strategy=None, n_estimators=None,
                                    n_jobs=None, num_parallel_tree=None,
                                    random_state=None, ...),
             param_grid={'learning_rate': [0.1, 0.01, 0.001],
                         'max_depth': [3, 6, 10], 'n_estimators': [100]},
             scoring='neg_root_mean_squared_error', verbose=5)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox"><label for="sk-estimator-id-5" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;GridSearchCV<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.4/modules/generated/sklearn.model_selection.GridSearchCV.html">?<span>Documentation for GridSearchCV</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>GridSearchCV(cv=5,
             estimator=XGBRegressor(base_score=None, booster=None,
                                    callbacks=None, colsample_bylevel=None,
                                    colsample_bynode=None,
                                    colsample_bytree=None, device=None,
                                    early_stopping_rounds=None,
                                    enable_categorical=True, eval_metric='rmse',
                                    feature_types=None, gamma=None,
                                    grow_policy=None, importance_type=None,
                                    interaction_constraints=None,
                                    learning_rate=None,...
                                    max_cat_to_onehot=None, max_delta_step=None,
                                    max_depth=None, max_leaves=None,
                                    min_child_weight=None, missing=nan,
                                    monotone_constraints=None,
                                    multi_strategy=None, n_estimators=None,
                                    n_jobs=None, num_parallel_tree=None,
                                    random_state=None, ...),
             param_grid={'learning_rate': [0.1, 0.01, 0.001],
                         'max_depth': [3, 6, 10], 'n_estimators': [100]},
             scoring='neg_root_mean_squared_error', verbose=5)</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox"><label for="sk-estimator-id-6" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">estimator: XGBRegressor</label><div class="sk-toggleable__content fitted"><pre>XGBRegressor(base_score=None, booster=None, callbacks=None,
             colsample_bylevel=None, colsample_bynode=None,
             colsample_bytree=None, device=None, early_stopping_rounds=None,
             enable_categorical=True, eval_metric='rmse', feature_types=None,
             gamma=None, grow_policy=None, importance_type=None,
             interaction_constraints=None, learning_rate=None, max_bin=None,
             max_cat_threshold=None, max_cat_to_onehot=None,
             max_delta_step=None, max_depth=None, max_leaves=None,
             min_child_weight=None, missing=nan, monotone_constraints=None,
             multi_strategy=None, n_estimators=None, n_jobs=None,
             num_parallel_tree=None, random_state=None, ...)</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox"><label for="sk-estimator-id-7" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">XGBRegressor</label><div class="sk-toggleable__content fitted"><pre>XGBRegressor(base_score=None, booster=None, callbacks=None,
             colsample_bylevel=None, colsample_bynode=None,
             colsample_bytree=None, device=None, early_stopping_rounds=None,
             enable_categorical=True, eval_metric='rmse', feature_types=None,
             gamma=None, grow_policy=None, importance_type=None,
             interaction_constraints=None, learning_rate=None, max_bin=None,
             max_cat_threshold=None, max_cat_to_onehot=None,
             max_delta_step=None, max_depth=None, max_leaves=None,
             min_child_weight=None, missing=nan, monotone_constraints=None,
             multi_strategy=None, n_estimators=None, n_jobs=None,
             num_parallel_tree=None, random_state=None, ...)</pre></div> </div></div></div></div></div></div></div></div></div>
</div>
</div>
<div id="24d7ea48" class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co"># After fitting, get the best parameters and retrain the model</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>best_params_os <span class="op">=</span> xgb_tuned.best_params_</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>best_xgb_os <span class="op">=</span> XGBRegressor(<span class="op">**</span>best_params_os, use_label_encoder<span class="op">=</span><span class="va">False</span>, eval_metric<span class="op">=</span><span class="st">"rmse"</span>, enable_categorical<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the new model to training data</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>best_xgb_os.fit(X_train, y_train_os)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<style>#sk-container-id-4 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-4 {
  color: var(--sklearn-color-text);
}

#sk-container-id-4 pre {
  padding: 0;
}

#sk-container-id-4 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-4 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-4 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-4 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-4 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-4 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-4 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-4 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-4 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-4 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-4 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-4 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-4 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-4 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-4 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-4 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-4 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-4 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-4 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-4 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-4 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-4 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-4 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-4 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-4 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-4 div.sk-label label.sk-toggleable__label,
#sk-container-id-4 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-4 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-4 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-4 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-4 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-4 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-4 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-4 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-4 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-4 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-4 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-4 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-4 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</a></style><div id="sk-container-id-4" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>XGBRegressor(base_score=None, booster=None, callbacks=None,
             colsample_bylevel=None, colsample_bynode=None,
             colsample_bytree=None, device=None, early_stopping_rounds=None,
             enable_categorical=True, eval_metric='rmse', feature_types=None,
             gamma=None, grow_policy=None, importance_type=None,
             interaction_constraints=None, learning_rate=0.1, max_bin=None,
             max_cat_threshold=None, max_cat_to_onehot=None,
             max_delta_step=None, max_depth=6, max_leaves=None,
             min_child_weight=None, missing=nan, monotone_constraints=None,
             multi_strategy=None, n_estimators=100, n_jobs=None,
             num_parallel_tree=None, random_state=None, ...)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox" checked=""><label for="sk-estimator-id-8" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;XGBRegressor<span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>XGBRegressor(base_score=None, booster=None, callbacks=None,
             colsample_bylevel=None, colsample_bynode=None,
             colsample_bytree=None, device=None, early_stopping_rounds=None,
             enable_categorical=True, eval_metric='rmse', feature_types=None,
             gamma=None, grow_policy=None, importance_type=None,
             interaction_constraints=None, learning_rate=0.1, max_bin=None,
             max_cat_threshold=None, max_cat_to_onehot=None,
             max_delta_step=None, max_depth=6, max_leaves=None,
             min_child_weight=None, missing=nan, monotone_constraints=None,
             multi_strategy=None, n_estimators=100, n_jobs=None,
             num_parallel_tree=None, random_state=None, ...)</pre></div> </div></div></div></div>
</div>
</div>
<div id="4d8788c7" class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a training copy of the data where 'training' equals 1</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb_train <span class="op">=</span> pentathlon_nptb[pentathlon_nptb[<span class="st">'training'</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the 7 different "message" values</span></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>message_values <span class="op">=</span> [<span class="st">'team'</span>, <span class="st">'backcountry'</span>, <span class="st">'endurance'</span>, <span class="st">'water'</span>, <span class="st">'racquet'</span>, <span class="st">'strength'</span>, <span class="st">'control'</span>]</span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> value <span class="kw">in</span> message_values:</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the training set for the current message</span></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a>    current_train <span class="op">=</span> pentathlon_nptb_train[pentathlon_nptb_train[<span class="st">'message'</span>] <span class="op">==</span> value]</span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create X_train and y_train for the current message</span></span>
<span id="cb255-12"><a href="#cb255-12" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> current_train[evar]</span>
<span id="cb255-13"><a href="#cb255-13" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> current_train[rvar_os]</span>
<span id="cb255-14"><a href="#cb255-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb255-15"><a href="#cb255-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the model to the training data for the current message</span></span>
<span id="cb255-16"><a href="#cb255-16" aria-hidden="true" tabindex="-1"></a>    best_xgb_os.fit(X_train, y_train)</span>
<span id="cb255-17"><a href="#cb255-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb255-18"><a href="#cb255-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict orer size for the entire dataset</span></span>
<span id="cb255-19"><a href="#cb255-19" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[<span class="ss">f'os_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">_xgb'</span>] <span class="op">=</span> best_xgb_os.predict(pentathlon_nptb[evar]).<span class="bu">round</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/777574624.py:19: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
</div>
<div id="fb78bd4f" class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> [<span class="st">'team'</span>, <span class="st">'backcountry'</span>, <span class="st">'endurance'</span>, <span class="st">'water'</span>, <span class="st">'racquet'</span>, <span class="st">'strength'</span>, <span class="st">'control'</span>]</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>Profit_margin <span class="op">=</span> <span class="dv">1</span><span class="op">-</span><span class="fl">0.6</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> value <span class="kw">in</span> values:</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[<span class="ss">f'ep_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">_xgb'</span>] <span class="op">=</span> pentathlon_nptb[<span class="ss">f'p_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">_xgb'</span>] <span class="op">*</span> pentathlon_nptb[<span class="ss">f'os_</span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">_xgb'</span>] <span class="op">*</span> Profit_margin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`

/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1144112266.py:6: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
</div>
<div id="648ae3e4" class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>expected_profit_xgb <span class="op">=</span> [</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_control_xgb"</span>, </span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_endurance_xgb"</span>, </span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_backcountry_xgb"</span>, </span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_racquet_xgb"</span>, </span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_strength_xgb"</span>, </span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_team_xgb"</span>, </span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_water_xgb"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bd0d354f" class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>repl <span class="op">=</span> {<span class="st">"ep_control_xgb"</span>: <span class="st">"control"</span>, <span class="st">"ep_endurance_xgb"</span>: <span class="st">"endurance"</span>, <span class="st">"ep_backcountry_xgb"</span>: <span class="st">"backcountry"</span>, <span class="st">"ep_racquet_xgb"</span>: <span class="st">"racquet"</span>, <span class="st">"ep_strength_xgb"</span>: <span class="st">"strength"</span>, <span class="st">"ep_team_xgb"</span>: <span class="st">"team"</span>, <span class="st">"ep_water_xgb"</span>: <span class="st">"water"</span>}</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_message_xgb"</span>] <span class="op">=</span> (</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>    pentathlon_nptb[expected_profit_xgb]</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>    .idxmax(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(repl)</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/3163695219.py:2: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
</div>
<div id="e38b2053" class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to look up the profit value based on ep_message_xgb</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ep(row):</span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mapping each ep_message_xgb value to the corresponding profit column</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>    mapping <span class="op">=</span> {</span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'control'</span>: <span class="st">'ep_control_xgb'</span>,</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'endurance'</span>: <span class="st">'ep_endurance_xgb'</span>,</span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'backcountry'</span>: <span class="st">'ep_backcountry_xgb'</span>,</span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'racquet'</span>: <span class="st">'ep_racquet_xgb'</span>,</span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'strength'</span>: <span class="st">'ep_strength_xgb'</span>,</span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'team'</span>: <span class="st">'ep_team_xgb'</span>,</span>
<span id="cb262-11"><a href="#cb262-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'water'</span>: <span class="st">'ep_water_xgb'</span>,</span>
<span id="cb262-12"><a href="#cb262-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb262-13"><a href="#cb262-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb262-14"><a href="#cb262-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the profit column name for the current row's message</span></span>
<span id="cb262-15"><a href="#cb262-15" aria-hidden="true" tabindex="-1"></a>    profit_col <span class="op">=</span> mapping.get(row[<span class="st">'ep_message_xgb'</span>])</span>
<span id="cb262-16"><a href="#cb262-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb262-17"><a href="#cb262-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the value from the corresponding profit column for this row</span></span>
<span id="cb262-18"><a href="#cb262-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> profit_col:</span>
<span id="cb262-19"><a href="#cb262-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row[profit_col]</span>
<span id="cb262-20"><a href="#cb262-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb262-21"><a href="#cb262-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb262-22"><a href="#cb262-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-23"><a href="#cb262-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each row to create a new column with the corresponding profit value</span></span>
<span id="cb262-24"><a href="#cb262-24" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_message_max_p'</span>] <span class="op">=</span> pentathlon_nptb.<span class="bu">apply</span>(get_ep, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1040504524.py:24: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
</div>
<div id="2efdeba2" class="cell" data-execution_count="170">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>ep_profit <span class="op">=</span> pentathlon_nptb.groupby(<span class="st">'ep_message_xgb'</span>)[<span class="st">'ep_message_max_p'</span>].<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a>ep_profit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="170">
<pre><code>ep_message_xgb
endurance      43977.37
strength       37358.12
water          30991.18
backcountry    26557.67
team           21474.36
racquet        18135.07
control         9657.12
Name: ep_message_max_p, dtype: float64</code></pre>
</div>
</div>
<div id="f49e5181" class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of ep_profit</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>ep_profit.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Expected Profit by Message'</span>)</span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Message Type'</span>)</span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Total Profit'</span>)</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate labels to make them readable</span></span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-172-output-1.png" width="837" height="581" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit.-1" class="level3">
<h3 class="anchored" data-anchor-id="report-for-each-message-i.e.-endurance-racket-etc.-and-no-message-the-percentage-of-customers-for-whom-that-no-message-maximizes-their-expected-profit.-1">4. Report for each message, i.e., endurance, racket, etc., and no-message, the percentage of customers for whom that (no) message maximizes their expected profit.</h3>
<div id="f2623a4c" class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>Message_max <span class="op">=</span> pentathlon_nptb.ep_message_xgb.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>Message_max</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="172">
<pre><code>ep_message_xgb
control        0.576705
strength       0.091172
endurance      0.082492
water          0.067795
team           0.066832
backcountry    0.065020
racquet        0.049985
Name: proportion, dtype: float64</code></pre>
</div>
</div>
<div id="56cb4978" class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>Message_max.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Percentage of Customers'</span>)</span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Message Type'</span>)</span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Percentage of Customers for Each Message Value'</span>)</span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate labels to make them readable</span></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-174-output-1.png" width="816" height="581" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer" class="level3">
<h3 class="anchored" data-anchor-id="the-expected-profit-can-we-obtain-on-average-per-customer-if-we-customize-the-message-to-each-customer">5. The expected profit can we obtain, on average, per customer if we customize the message to each customer</h3>
<div id="9c1bc30e" class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>avg_profit_pc <span class="op">=</span> pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>].groupby(<span class="st">'ep_message_xgb'</span>)[<span class="st">'ep_message_max_p'</span>].mean().sort_values(ascending<span class="op">=</span><span class="va">False</span>).<span class="bu">round</span>(<span class="dv">2</span>) <span class="op">*</span> Profit_margin</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>avg_profit_pc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="174">
<pre><code>ep_message_xgb
endurance      0.336
strength       0.284
water          0.280
backcountry    0.264
racquet        0.232
team           0.196
control        0.008
Name: ep_message_max_p, dtype: float64</code></pre>
</div>
</div>
<div id="3dbf5031" class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of ep_profit</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>avg_profit_pc.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Expected Profit Per Customer'</span>)</span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Message Type'</span>)</span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Profit'</span>)</span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate labels to make them readable</span></span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-176-output-1.png" width="824" height="581" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message" class="level3">
<h3 class="anchored" data-anchor-id="the-expected-profit-per-e-mailed-customer-if-every-customer-receives-the-same-message">6. The expected profit per e-mailed customer if every customer receives the same message</h3>
<div id="44ce0ec8" class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>expected_profit_xgb <span class="op">=</span> [</span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_control_xgb"</span>, </span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_endurance_xgb"</span>, </span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_backcountry_xgb"</span>, </span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_racquet_xgb"</span>, </span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_strength_xgb"</span>, </span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_team_xgb"</span>, </span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_water_xgb"</span>]</span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected profit per customer for each message</span></span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>epp_same_message <span class="op">=</span> pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>][expected_profit_xgb].mean().sort_values(ascending<span class="op">=</span><span class="va">False</span>) <span class="op">*</span> Profit_margin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5276373c" class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of ep_profit</span></span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>epp_same_message.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Expected Profit Per Customer'</span>)</span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Message Type'</span>)</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Profit'</span>)</span>
<span id="cb274-7"><a href="#cb274-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate labels to make them readable</span></span>
<span id="cb274-8"><a href="#cb274-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-178-output-1.png" width="824" height="621" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition" class="level3">
<h3 class="anchored" data-anchor-id="the-expected-profit-per-e-mailed-customer-if-every-customer-is-assigned-randomly-to-one-of-the-messages-or-the-no-message-condition">7. The expected profit per e-mailed customer if every customer is assigned randomly to one of the messages or the no-message condition</h3>
<div id="7e0efb13" class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">'ep_random_xgb'</span>] <span class="op">=</span> best_xgb.predict_proba(pentathlon_nptb[evar])[:, <span class="dv">1</span>]</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>xgb_random_ppc <span class="op">=</span> pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>][<span class="st">'ep_random_xgb'</span>].mean() <span class="op">*</span> Profit_margin</span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>xgb_random_ppc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/3633768350.py:1: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="178">
<pre><code>0.008396312594413757</code></pre>
</div>
</div>
<div id="92afc508" class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>expected_profit_xgb <span class="op">=</span> [</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_control_xgb"</span>, </span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_endurance_xgb"</span>, </span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_backcountry_xgb"</span>, </span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_racquet_xgb"</span>, </span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_strength_xgb"</span>, </span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_team_xgb"</span>, </span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_water_xgb"</span>,</span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ep_random_xgb"</span>]</span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected profit per customer for each message</span></span>
<span id="cb278-12"><a href="#cb278-12" aria-hidden="true" tabindex="-1"></a>epp_same_message <span class="op">=</span> pentathlon_nptb[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>][expected_profit_xgb].mean().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e1c49934" class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of ep_profit</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>epp_same_message.plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Expected Profit Per Customer'</span>)</span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Message Type'</span>)</span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Average Profit'</span>)</span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)  <span class="co"># Rotate labels to make them readable</span></span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-181-output-1.png" width="824" height="621" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="for-the-typical-promotional-e-mail-blast-to-5000000-customers-the-improvement-in-percent-and-in-total-euros-could-pentathlon-achieve-by-customizing-the-message-or-no-message-to-each-customer" class="level3">
<h3 class="anchored" data-anchor-id="for-the-typical-promotional-e-mail-blast-to-5000000-customers-the-improvement-in-percent-and-in-total-euros-could-pentathlon-achieve-by-customizing-the-message-or-no-message-to-each-customer">8. For the typical promotional e-mail blast to 5,000,000 customers, The improvement (in percent and in total Euros) could Pentathlon achieve by customizing the message (or no-message) to each customer:</h3>
<div id="5638987c" class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max_xgb"</span>] <span class="op">=</span> pentathlon_nptb[expected_profit_xgb].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_max_xgb"</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1479503728.py:1: PerformanceWarning:

DataFrame is highly fragmented.  This is usually the result of calling `frame.insert` many times, which has poor performance.  Consider joining all columns at once using pd.concat(axis=1) instead. To get a de-fragmented frame, use `newframe = frame.copy()`
</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="181">
<pre><code>0.31611574</code></pre>
</div>
</div>
<div id="dd005acc" class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where each customer is assigned to the message with the highest expected profit</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>profit_xgb <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_max_xgb"</span>].agg(<span class="st">"mean"</span>) <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>profit_xgb </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="182">
<pre><code>1511183.9771270752</code></pre>
</div>
</div>
<div id="72cfd850" class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where each customer is sent to a random message</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>random_profit_xgb <span class="op">=</span> xgb_random_ppc <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>random_profit_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="183">
<pre><code>41981.56297206879</code></pre>
</div>
</div>
<div id="26421a7d" class="cell" data-execution_count="184">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit where no-message is sent (control)</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>pentathlon_nptb[<span class="st">"ep_control_xgb"</span>]</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a><span class="co"># expected profit per customer where no-message is sent (control)</span></span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer <span class="op">=</span> pentathlon_nptb.loc[pentathlon_nptb.training <span class="op">==</span> <span class="dv">0</span>, <span class="st">"ep_control_xgb"</span>].mean()</span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>control_profit_per_customer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="184">
<pre><code>0.078689866</code></pre>
</div>
</div>
<div id="34ca6b81" class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Profit where no message is sent</span></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>control_profit_xgb <span class="op">=</span> control_profit_per_customer <span class="op">*</span> <span class="dv">5000000</span></span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>control_profit_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="185">
<pre><code>393449.3288397789</code></pre>
</div>
</div>
<div id="9ae0e40e" class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>profit_improvement_xgb <span class="op">=</span> profit_xgb <span class="op">-</span> control_profit_xgb</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>profit_improvement_xgb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<pre><code>1117734.6482872963</code></pre>
</div>
</div>
<div id="fa2895b3" class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>profits_dct <span class="op">=</span> {</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Customize Message"</span>: profit_xgb,</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No Message Sent"</span>: control_profit_nn,</span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Randomly Assign"</span>: random_profit_xgb,</span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dictionary to DataFrame</span></span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(profits_dct.items()), columns<span class="op">=</span>[<span class="st">'Model'</span>, <span class="st">'Profit'</span>])</span>
<span id="cb293-14"><a href="#cb293-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))  </span>
<span id="cb293-15"><a href="#cb293-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb293-16"><a href="#cb293-16" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb293-17"><a href="#cb293-17" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"Model"</span>, y<span class="op">=</span><span class="st">"Profit"</span>, data<span class="op">=</span>df, palette<span class="op">=</span><span class="st">"viridis"</span>)</span>
<span id="cb293-18"><a href="#cb293-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-19"><a href="#cb293-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotations</span></span>
<span id="cb293-20"><a href="#cb293-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb293-21"><a href="#cb293-21" aria-hidden="true" tabindex="-1"></a>    ax.text(index, row.Profit, <span class="ss">f'$</span><span class="sc">{</span>row<span class="sc">.</span>Profit<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb293-22"><a href="#cb293-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-23"><a href="#cb293-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb293-24"><a href="#cb293-24" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Model Type"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb293-25"><a href="#cb293-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Profit"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb293-26"><a href="#cb293-26" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Profit by Model"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">15</span>})</span>
<span id="cb293-27"><a href="#cb293-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-28"><a href="#cb293-28" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>) </span>
<span id="cb293-29"><a href="#cb293-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/1574157434.py:17: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-188-output-2.png" width="817" height="549" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="improvement-profit-for-4-models" class="level2">
<h2 class="anchored" data-anchor-id="improvement-profit-for-4-models">Improvement Profit for 4 models</h2>
<div id="8bb2f9bd" class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>mod_perf <span class="op">=</span> pd.DataFrame({</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model"</span>: [<span class="st">"logit"</span>, <span class="st">"nn"</span>, <span class="st">"rf"</span>, <span class="st">"xgb"</span>],</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"profit"</span>: [profit_improvement_lr, profit_improvement_nn, profit_improvement_rf, profit_improvement_xgb]</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>mod_perf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="188">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">profit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>logit</td>
<td>1.238407e+06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>nn</td>
<td>1.262522e+06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>rf</td>
<td>2.510230e+06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>xgb</td>
<td>1.117735e+06</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="1bfd469e" class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>profits_dct <span class="op">=</span> {</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Logit"</span>: profit_improvement_lr,</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neural Network"</span>: profit_improvement_nn,</span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Random Forest"</span> : profit_improvement_rf,</span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"XGBoost"</span>: profit_improvement_xgb</span>
<span id="cb296-6"><a href="#cb296-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb296-7"><a href="#cb296-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb296-8"><a href="#cb296-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-9"><a href="#cb296-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-10"><a href="#cb296-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb296-11"><a href="#cb296-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb296-12"><a href="#cb296-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-13"><a href="#cb296-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dictionary to DataFrame</span></span>
<span id="cb296-14"><a href="#cb296-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(profits_dct.items()), columns<span class="op">=</span>[<span class="st">'Model'</span>, <span class="st">'Profit'</span>])</span>
<span id="cb296-15"><a href="#cb296-15" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))  </span>
<span id="cb296-16"><a href="#cb296-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb296-17"><a href="#cb296-17" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb296-18"><a href="#cb296-18" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"Model"</span>, y<span class="op">=</span><span class="st">"Profit"</span>, data<span class="op">=</span>df, palette<span class="op">=</span><span class="st">"viridis"</span>)</span>
<span id="cb296-19"><a href="#cb296-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-20"><a href="#cb296-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotations</span></span>
<span id="cb296-21"><a href="#cb296-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb296-22"><a href="#cb296-22" aria-hidden="true" tabindex="-1"></a>    ax.text(index, row.Profit, <span class="ss">f'$</span><span class="sc">{</span>row<span class="sc">.</span>Profit<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb296-23"><a href="#cb296-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-24"><a href="#cb296-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb296-25"><a href="#cb296-25" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Model Type"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb296-26"><a href="#cb296-26" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Profit"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">12</span>})</span>
<span id="cb296-27"><a href="#cb296-27" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Profit Improvement by Model"</span>, fontdict<span class="op">=</span>{<span class="st">'family'</span>: <span class="st">'serif'</span>, <span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'size'</span>: <span class="dv">15</span>})</span>
<span id="cb296-28"><a href="#cb296-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-29"><a href="#cb296-29" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>) </span>
<span id="cb296-30"><a href="#cb296-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/28/cfl1_cfs3bb536qkz8wkys_w0000gn/T/ipykernel_31928/2950013552.py:18: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="pentathlon_nptb_files/figure-html/cell-190-output-2.png" width="817" height="527" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>According to the chart, Random Forest outperforms the other models in terms of profit improvement but takes more than 2 hours to tune the model.</p>
<ul>
<li>Weaknesses of the Random Forest Model:</li>
</ul>
<p>Computational Complexity: Random Forest can be computationally intensive, especially as the number of trees and the depth of each tree increase. This is likely the cause of the long tunning time. The complexity grows with the size of the dataset, the number of features, and the model parameters.</p>
<p>Scalability: Because of the computational cost, scaling Random Forest to very large datasets or high-dimensional data can be challenging and might require significant computational resources.</p>
<p>Model Interpretability: While not as complex as some other models like neural networks, Random Forests are still considered a “black box” compared to simpler models like Logistic Regression. This can make it difficult to understand the decision-making process of the model and to explain individual predictions.</p>
<p>Tuning Required: Random Forest models have several hyperparameters (like the number of trees, max depth, min samples split, etc.) that can greatly influence performance. Finding the optimal settings can be time-consuming and require a lot of trial and error or automated search techniques like grid search or random search, which can further increase the computational burden.</p>
<ul>
<li>Suggested Improvement:</li>
</ul>
<p>Model Simplification: We should simplying the model by reducing the number of trees or the depth of each tree, which might reduce training time at the cost of some accuracy.</p>
<p>Feature Selection: Reducing the number of features through feature selection can significantly decrease training time and sometimes even improve model performance by eliminating noise.</p>
<p>Incremental Learning: Some models allow for incremental learning, where the model is trained on chunks of the dataset sequentially, which can reduce memory consumption and potentially training time.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>